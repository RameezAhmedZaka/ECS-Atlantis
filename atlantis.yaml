---
version: 3
automerge: true
parallel_plan: true
parallel_apply: false
projects:
  - name: application-app11-helia
    dir: application/app11/env/helia
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: helia_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-app11-production
    dir: application/app11/env/production
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: production_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-app11-staging
    dir: application/app11/env/staging
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: staging_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-helia
    dir: application/rdot/env/helia
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: helia_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-production
    dir: application/rdot/env/production
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: production_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-rameez
    dir: application/rdot/env/rameez
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: rameez_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-staging
    dir: application/rdot/env/staging
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: staging_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-production
    dir: db/db1/env/production
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: production_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db71-staging
    dir: db/db71/env/staging
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: staging_workflow
    apply_requirements:
      - approved
      - mergeable
workflows:
  helia_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: helia"
            echo "Using backend config: env/helia/helia.conf"
            echo "Using tfvars file: config/helia.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/helia/helia.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/helia.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: helia"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  production_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            echo "Using backend config: env/production/prod.conf
env/production/prod.conf
env/production/prod.conf"
            echo "Using tfvars file: config/production.tfvars
config/production.tfvars
config/production.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/production/prod.conf
env/production/prod.conf
env/production/prod.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/production.tfvars
config/production.tfvars
config/production.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  staging_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            echo "Using backend config: env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf"
            echo "Using tfvars file: config/stage.tfvars
config/stage.tfvars
config/stage.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/stage.tfvars
config/stage.tfvars
config/stage.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  helia_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: helia"
            echo "Using backend config: env/helia/helia.conf"
            echo "Using tfvars file: config/helia.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/helia/helia.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/helia.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: helia"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  production_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            echo "Using backend config: env/production/prod.conf
env/production/prod.conf
env/production/prod.conf"
            echo "Using tfvars file: config/production.tfvars
config/production.tfvars
config/production.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/production/prod.conf
env/production/prod.conf
env/production/prod.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/production.tfvars
config/production.tfvars
config/production.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  rameez_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: rameez"
            echo "Using backend config: env/rameez/rame.conf"
            echo "Using tfvars file: config/rameez.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/rameez/rame.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/rameez.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: rameez"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  staging_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            echo "Using backend config: env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf"
            echo "Using tfvars file: config/stage.tfvars
config/stage.tfvars
config/stage.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/stage.tfvars
config/stage.tfvars
config/stage.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  production_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            echo "Using backend config: env/production/prod.conf
env/production/prod.conf
env/production/prod.conf"
            echo "Using tfvars file: config/production.tfvars
config/production.tfvars
config/production.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/production/prod.conf
env/production/prod.conf
env/production/prod.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/production.tfvars
config/production.tfvars
config/production.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: production"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
  staging_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            echo "Using backend config: env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf"
            echo "Using tfvars file: config/stage.tfvars
config/stage.tfvars
config/stage.tfvars"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=env/staging/stage.conf
env/staging/stage.conf
env/staging/stage.conf -reconfigure -lock=false -input=false > /dev/null 2>&1
            terraform plan -var-file=config/stage.tfvars
config/stage.tfvars
config/stage.tfvars -lock-timeout=10m -out=$PLANFILE
    apply:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Environment: staging"
            cd "$(dirname "$PROJECT_DIR")/../.."
            terraform apply -auto-approve $PLANFILE
