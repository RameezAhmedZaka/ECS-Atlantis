version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: []

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable]

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="staging"
              echo "ðŸ”µ Running Staging plan with APP_FILTER='$APP_FILTER'"
              # Clean up any existing plan files to prevent contamination
              rm -f /tmp/atlantis_planfiles_*.lst
              rm -f /tmp/atlantis_custom_output_*.md
              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER"

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="staging"
              echo "ðŸ”µ Applying Staging changes with APP_FILTER='$APP_FILTER'"
              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="production"
              echo "ðŸ”´ Running Production plan with APP_FILTER='$APP_FILTER'"
              # Clean up any existing plan files to prevent contamination
              rm -f /tmp/atlantis_planfiles_*.lst
              rm -f /tmp/atlantis_custom_output_*.md
              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER"

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="production"
              echo "ðŸ”´ Applying Production changes with APP_FILTER='$APP_FILTER'"
              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="helia"
              echo "ðŸŸ£ Running Helia plan with APP_FILTER='$APP_FILTER'"
              # Clean up any existing plan files to prevent contamination
              rm -f /tmp/atlantis_planfiles_*.lst
              rm -f /tmp/atlantis_custom_output_*.md
              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER"

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="helia"
              echo "ðŸŸ£ Applying Helia changes with APP_FILTER='$APP_FILTER'"
              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"