version: 3
automerge: false 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: [] 

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable] 

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true 
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []     

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "DEBUG: Raw COMMENT_ARGS='$COMMENT_ARGS'"
            echo "DEBUG: Cleaned APP_FILTER='$APP_FILTER'"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output file
        - run: |
            set -euo pipefail
            ENV="staging"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            
            # Start with the standard plan summary
            echo "Plan: 10 to add, 0 to change, 0 to destroy." > "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            if [[ -f "$PLANLIST" ]]; then
              echo "=== CUSTOM APPLY COMMANDS ===" >> "$OUTPUT_FILE"
              APP_COUNT=0
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  echo "â–¶ï¸ To apply $APP_NAME, comment:" >> "$OUTPUT_FILE"
                  echo "   atlantis apply -p apps-staging -- $APP_NAME" >> "$OUTPUT_FILE"
                  ((APP_COUNT++))
                fi
              done < "$PLANLIST"
              
              echo "" >> "$OUTPUT_FILE"
              if [[ $APP_COUNT -gt 1 ]]; then
                echo "â© To apply all $APP_COUNT apps, comment:" >> "$OUTPUT_FILE"
                echo "   atlantis apply -p apps-staging" >> "$OUTPUT_FILE"
              fi
              
              echo "" >> "$OUTPUT_FILE"
              echo "ðŸš® To delete this plan and lock, click here" >> "$OUTPUT_FILE"
              echo "ðŸ” To plan this project again, comment:" >> "$OUTPUT_FILE"
              echo "   atlantis plan -p apps-staging" >> "$OUTPUT_FILE"
            fi
        # Use custom output
        - run: |
            ENV="staging"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            if [[ -f "$OUTPUT_FILE" ]]; then
              cat "$OUTPUT_FILE"
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output file
        - run: |
            set -euo pipefail
            ENV="production"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            
            # Start with the standard plan summary
            echo "Plan: 10 to add, 0 to change, 0 to destroy." > "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            if [[ -f "$PLANLIST" ]]; then
              echo "=== CUSTOM APPLY COMMANDS ===" >> "$OUTPUT_FILE"
              APP_COUNT=0
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  echo "â–¶ï¸ To apply $APP_NAME, comment:" >> "$OUTPUT_FILE"
                  echo "   atlantis apply -p apps-production -- $APP_NAME" >> "$OUTPUT_FILE"
                  ((APP_COUNT++))
                fi
              done < "$PLANLIST"
              
              echo "" >> "$OUTPUT_FILE"
              if [[ $APP_COUNT -gt 1 ]]; then
                echo "â© To apply all $APP_COUNT apps, comment:" >> "$OUTPUT_FILE"
                echo "   atlantis apply -p apps-production" >> "$OUTPUT_FILE"
              fi
              
              echo "" >> "$OUTPUT_FILE"
              echo "ðŸš® To delete this plan and lock, click here" >> "$OUTPUT_FILE"
              echo "ðŸ” To plan this project again, comment:" >> "$OUTPUT_FILE"
              echo "   atlantis plan -p apps-production" >> "$OUTPUT_FILE"
            fi
        # Use custom output
        - run: |
            ENV="production"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            if [[ -f "$OUTPUT_FILE" ]]; then
              cat "$OUTPUT_FILE"
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output file
        - run: |
            set -euo pipefail
            ENV="helia"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            
            # Start with the standard plan summary
            echo "Plan: 10 to add, 0 to change, 0 to destroy." > "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
            
            if [[ -f "$PLANLIST" ]]; then
              echo "=== CUSTOM APPLY COMMANDS ===" >> "$OUTPUT_FILE"
              APP_COUNT=0
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  echo "â–¶ï¸ To apply $APP_NAME, comment:" >> "$OUTPUT_FILE"
                  echo "   atlantis apply -p apps-helia -- $APP_NAME" >> "$OUTPUT_FILE"
                  ((APP_COUNT++))
                fi
              done < "$PLANLIST"
              
              echo "" >> "$OUTPUT_FILE"
              if [[ $APP_COUNT -gt 1 ]]; then
                echo "â© To apply all $APP_COUNT apps, comment:" >> "$OUTPUT_FILE"
                echo "   atlantis apply -p apps-helia" >> "$OUTPUT_FILE"
              fi
              
              echo "" >> "$OUTPUT_FILE"
              echo "ðŸš® To delete this plan and lock, click here" >> "$OUTPUT_FILE"
              echo "ðŸ” To plan this project again, comment:" >> "$OUTPUT_FILE"
              echo "   atlantis plan -p apps-helia" >> "$OUTPUT_FILE"
            fi
        # Use custom output
        - run: |
            ENV="helia"
            OUTPUT_FILE="/tmp/atlantis_custom_output_${ENV}.txt"
            if [[ -f "$OUTPUT_FILE" ]]; then
              cat "$OUTPUT_FILE"
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"