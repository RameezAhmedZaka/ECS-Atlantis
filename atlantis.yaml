version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - name: multi-environment-apps
    dir: application
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: multi-env-workflow
    apply_requirements: []

workflows:
  multi-env-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            echo "=== Processing ALL environments ==="
            chmod +x ./process-application.sh
            # Plan for all environments
            ./process-application.sh "staging"
            ./process-application.sh "production" 
            ./process-application.sh "helia"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="$ENV"  # This will be set by Atlantis when applying
            echo "=== Applying $ENV environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"