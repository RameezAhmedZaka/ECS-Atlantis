version: 3
automerge: false  # Disable until working
parallel_plan: false  # Disable until working
parallel_apply: false  # Disable until working 

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  # DISABLE FOR TESTING
      when_modified:
        - "application/**/env/staging/**"
        - "application/**/config/stage.tfvars"
        - "application/**/main.tf"
    workflow: staging-workflow
    apply_requirements: [] 

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  # DISABLE FOR TESTING
      when_modified:
        - "application/**/env/production/**"
        - "application/**/config/production.tfvars"
        - "application/**/main.tf"
    workflow: production-workflow
    apply_requirements: [] 

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  # DISABLE FOR TESTING
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []     

workflows:
  staging-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Processing STAGING environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Applying STAGING environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"            

  production-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Processing PRODUCTION environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Applying PRODUCTION environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"

  helia-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "=== Processing HELIA environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "=== Applying HELIA environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"            

