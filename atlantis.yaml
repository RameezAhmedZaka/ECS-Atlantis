---
version: 3
automerge: false  # Disable automerge for debugging
parallel_plan: false
parallel_apply: false  # Force serial execution
projects:
  - name: application-rdot-helia
    dir: application/rdot/env/helia
    autoplan:
      enabled: true # Disable autoplan to prevent conflicts
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
  - name: application-rdot-staging
    dir: application/rdot/env/staging
    autoplan:
      enabled: true # Disable autoplan to prevent conflicts
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
  - name: application-rdot-production
    dir: application/rdot/env/production
    autoplan:
      enabled: true # Disable autoplan to prevent conflicts
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
  - name: db-db1-staging
    dir: db/db1/env/staging
    autoplan:
      enabled: true # Disable autoplan to prevent conflicts
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
  - name: db-db1-production
    dir: db/db1/env/production
    autoplan:
      enabled: true # Disable autoplan to prevent conflicts
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
workflows:
  multi_env_workflow:
    plan:
      steps:
        - run: |
            set -e
            echo "Starting plan for $PROJECT_NAME in directory: $PROJECT_DIR"
            
            PLANFILE="plan_${PROJECT_NAME}.tfplan"
            # Clean any existing plan files
            rm -f "plan_*.tfplan"
            
            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="../../env/production/prod.conf"
                VAR_FILE="../../config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="../../env/staging/stage.conf"
                VAR_FILE="../../config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="../../env/helia/helia.conf"
                VAR_FILE="../../config/helia.tfvars"
                ;;
              *)
                ENV="default"
                BACKEND_CONFIG=""
                VAR_FILE=""
                ;;
            esac

            echo "Planning for environment: $ENV"
            echo "Project directory: $PWD"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"

            # Clean up any existing terraform state in the current directory
            rm -rf .terraform
            rm -f .terraform.lock.hcl
            rm -f terraform.tfstate*
            rm -f *.tfplan

            # Initialize in the current project directory
            if [ -f "$BACKEND_CONFIG" ]; then
              echo "Initializing with backend config: $BACKEND_CONFIG"
              terraform init -backend-config="$BACKEND_CONFIG" -input=false -reconfigure
            else
              echo "Initializing without backend config"
              terraform init -input=false -reconfigure
            fi

            # Run plan
            if [ -f "$VAR_FILE" ]; then
              echo "Running plan with var file: $VAR_FILE"
              terraform plan -lock-timeout=20m -var-file="$VAR_FILE" -out="$PLANFILE"
            else
              echo "Running plan without var file"
              terraform plan -lock-timeout=20m -out="$PLANFILE"
            fi

            echo "Plan completed successfully"

    apply:
      steps:
        - run: |
            set -e
            echo "Starting apply for $PROJECT_NAME in directory: $PROJECT_DIR"
            
            PLANFILE="plan_${PROJECT_NAME}.tfplan"

            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="../../env/production/prod.conf"
                VAR_FILE="../../config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="../../env/staging/stage.conf"
                VAR_FILE="../../config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="../../env/helia/helia.conf"
                VAR_FILE="../../config/helia.tfvars"
                ;;
              *)
                ENV="default"
                BACKEND_CONFIG=""
                VAR_FILE=""
                ;;
            esac

            echo "Applying for environment: $ENV"
            echo "Project directory: $PWD"

            # Clean up any existing terraform state in the current directory
            rm -rf .terraform
            rm -f .terraform.lock.hcl
            rm -f terraform.tfstate*

            # Reinitialize to ensure clean state
            if [ -f "$BACKEND_CONFIG" ]; then
              echo "Reinitializing with backend config: $BACKEND_CONFIG"
              terraform init -backend-config="$BACKEND_CONFIG" -input=false -reconfigure
            else
              echo "Reinitializing without backend config"
              terraform init -input=false -reconfigure
            fi

            if [ -f "$PLANFILE" ]; then
              echo "Applying plan: $PLANFILE"
              terraform apply -input=false -lock-timeout=25m -auto-approve "$PLANFILE"
              
              # Clean up plan file after successful apply
              rm -f "$PLANFILE"
              echo "Apply completed successfully"
            else
              echo "Error: Plan file $PLANFILE not found"
              ls -la *.tfplan || echo "No plan files found"
              exit 1
            fi
