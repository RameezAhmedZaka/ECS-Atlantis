version: 3
automerge: false
parallel_plan: false
parallel_apply: false 

# Dynamic project discovery using regex
projects:
  - name: application-(\w+)-staging
    dir: application/{\1}
    workspace: staging
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/{\1}/**"
    workflow: staging-workflow
    apply_requirements: []

  - name: application-(\w+)-production
    dir: application/{\1}
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/{\1}/**"
    workflow: production-workflow
    apply_requirements: []

workflows:
  staging-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            # Extract app name from project name (application-adot-staging -> adot)
            APP_NAME=$(echo "$ATLANTIS_PROJECT_NAME" | sed 's/application-\(.*\)-staging/\1/')
            echo "=== Processing $APP_NAME STAGING environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_NAME"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Applying STAGING environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"

  production-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            # Extract app name from project name (application-adot-production -> adot)
            APP_NAME=$(echo "$ATLANTIS_PROJECT_NAME" | sed 's/application-\(.*\)-production/\1/')
            echo "=== Processing $APP_NAME PRODUCTION environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_NAME"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Applying PRODUCTION environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"