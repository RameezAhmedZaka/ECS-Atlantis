# version: 3

# projects:
#   - name: applications
#     dir: applications/*      
#     autoplan:
#       when_modified: ["*.tf", "config/*.tfvars", "env/**/*.conf"]
#       enabled: true
#     # workflow: default
#     apply_requirements: [approved, mergeable]

#   - name: databases
#     dir: databases/*          
#     autoplan:
#       when_modified: ["*.tf", "config/*.tfvars", "env/**/*.conf"]
#       enabled: true
#     # workflow: default
#     apply_requirements: [approved, mergeable]

# workflows:
#   default:
#     plan:
#       steps:
#         - init
#         - plan
#     apply:
#       steps:
#         - apply


# version: 3

# projects:
#   - name: applications
#     dir: applications/*      
#     autoplan:
#       when_modified: ["*.tf", "config/*.tfvars", "env/**/*.conf"]
#       enabled: true

#   - name: databases
#     dir: databases/*          
#     autoplan:
#       when_modified: ["*.tf", "config/*.tfvars", "env/**/*.conf"]
#       enabled: true

# workflows:
#   default:
#     plan:
#       steps:
#         - init
#         - plan
#     apply:
#       steps:
#         - apply

# version: 3
# projects:
#   - name: application
#     dir: application
#     workflow: custom-run

#     autoplan:
#       when_modified: ["*.tf", "config/*.tfvars", "modules/**/*.tf"]
#       enabled: true
#     apply_requirements: [] 
# workflows:
#   custom-run:
#     plan:
#       steps:
        # - run:
        #     command: ls
#         - init
#         - plan:
#             extra_args: ["-var-file=./config/dev.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/dev.tfvars"]


version: 3
projects:
  - name: application-dev-deploy
    dir: application/
    workspace: development
    workflow: dev-workflow
    apply_requirements: [] 
    autoplan:
      when_modified: ["*/**/*.tf", "*.tf", "*/./config/stage.tfvars", "*/./config/production.tfvars"]  #"custom_file"
      enabled: true

  - name: application-prod-deploy
    dir: application/
    workspace: production
    workflow: prod-workflow 
    apply_requirements: []
    autoplan:
      when_modified: ["*/**/*.tf", "*.tf", "*/./config/stage.tfvars", "*/./config/production.tfvars"] 
      enabled: true

workflows:
  dev-workflow:
    plan:
      steps:
        - run:
            command: |
              for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
                terraform -chdir=$d init -backend-config="$d/env/staging/stage.conf"
                terraform -chdir=$d plan -var-file="$d/config/stage.tfvars"
              done
    apply:
      steps:
        - run:
            command: |
              for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
                terraform -chdir=$d apply -var-file="$d/config/stage.tfvars" -auto-approve
              done

  prod-workflow:
    plan:
      steps:
        - run:
            command: |
              for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
                terraform -chdir=$d init -backend-config="$d/env/production/prod.conf"
                terraform -chdir=$d plan -var-file="$d/config/production.tfvars"
              done
    apply:
      steps:
        - run:
            command: |
              for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
                terraform -chdir=$d apply -var-file="$d/config/production.tfvars" -auto-approve
              done

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls
#         - init:
#             extra_args: ["-backend-config=env/staging/stage.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/stage.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/stage.tfvars"]

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls      
#         - init:
#             extra_args: ["-backend-config=env/production/prod.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/production.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/production.tfvars"]


  # - name: databases
  #   dir: databases/*
  #   autoplan:
  #     when_modified: ["databases/**/*.tf", "databases/**/config/*.tfvars", "databases/**/env/**/*.conf"]
  #     enabled: true