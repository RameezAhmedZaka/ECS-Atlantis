---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:

workflows:
  dynamic_environment:
    plan:
      steps:
        - run: |
            echo "Detecting environment for project: $PROJECT_NAME"
            
            # Get the app directory from project name
            APP_DIR="$DIR"
            
            # Check which files were modified to determine environment
            if [ -n "$(git diff --name-only HEAD~1 HEAD -- "${APP_DIR}/env/production/" 2>/dev/null || true)" ]; then
              ENV="production"
              BACKEND_CONFIG="env/production/prod.conf"
              VAR_FILE="config/production.tfvars"
            elif [ -n "$(git diff --name-only HEAD~1 HEAD -- "${APP_DIR}/env/staging/" 2>/dev/null || true)" ]; then
              ENV="staging"
              BACKEND_CONFIG="env/staging/stage.conf"
              VAR_FILE="config/stage.tfvars"
            elif [ -n "$(git diff --name-only HEAD~1 HEAD -- "${APP_DIR}/env/helia/" 2>/dev/null || true)" ]; then
              ENV="helia"
              BACKEND_CONFIG="env/helia/helia.conf"
              VAR_FILE="config/helia.tfvars"
            else
              # If no specific environment changed, plan for all environments or use default
              ENV="all"
              BACKEND_CONFIG="env/production/prod.conf"
              VAR_FILE="config/production.tfvars"
            fi
            
            echo "Selected environment: $ENV"
            echo "backend_config: $BACKEND_CONFIG"
            echo "var_file: $VAR_FILE"
            
            # Store environment in file for apply phase
            echo "$ENV" > /tmp/current_env.txt
            echo "$BACKEND_CONFIG" > /tmp/backend_config.txt
            echo "$VAR_FILE" > /tmp/var_file.txt
            
            # Initialize and plan
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config="$BACKEND_CONFIG" -reconfigure -lock=false -input=false
            terraform plan -var-file="$VAR_FILE" -lock-timeout=10m -out=tfplan.out
            
        - run: |
            # Copy plan file with environment context
            ENV=$(cat /tmp/current_env.txt)
            cp tfplan.out "../${PROJECT_NAME}-${ENV}-tfplan.out"
            echo "Plan file saved as: ${PROJECT_NAME}-${ENV}-tfplan.out"

    apply:
      steps:
        - run: |
            echo "Applying changes for project: $PROJECT_NAME"
            
            # Find the correct plan file based on environment
            APP_DIR="$DIR"
            ENV=$(cat /tmp/current_env.txt 2>/dev/null || echo "production")
            BACKEND_CONFIG=$(cat /tmp/backend_config.txt 2>/dev/null || echo "env/production/prod.conf")
            VAR_FILE=$(cat /tmp/var_file.txt 2>/dev/null || echo "config/production.tfvars")
            
            PLAN_FILE="../${PROJECT_NAME}-${ENV}-tfplan.out"
            
            if [ ! -f "$PLAN_FILE" ]; then
              echo "Error: Plan file not found: $PLAN_FILE"
              echo "Available plan files:"
              ls -la ../*.out 2>/dev/null || echo "No plan files found"
              exit 1
            fi
            
            echo "Using plan file: $PLAN_FILE"
            echo "Environment: $ENV"
            
            # Initialize with same backend config
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config="$BACKEND_CONFIG" -reconfigure -lock=false -input=false
            
            # Apply the plan
            terraform apply -auto-approve "$PLAN_FILE"
            
            # Cleanup
            rm -f "$PLAN_FILE"

