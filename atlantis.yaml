---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
  - name: application-rdot-helia
    dir: .
    autoplan:
      enabled: true
      when_modified:
        - "application/rdot/*.tf"
        - "application/rdot/config/*.tfvars"
        - "application/rdot/env/*/*"
    terraform_version: v1.6.6
    workflow: helia_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-production
    dir: .
    autoplan:
      enabled: true
      when_modified:
        - "application/rdot/*.tf"
        - "application/rdot/config/*.tfvars"
        - "application/rdot/env/*/*"
    terraform_version: v1.6.6
    workflow: production_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-staging
    dir: .
    autoplan:
      enabled: true
      when_modified:
        - "db/db1/*.tf"
        - "db/db1/config/*.tfvars"
        - "db/db1/env/*/*"
    terraform_version: v1.6.6
    workflow: staging_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-production
    dir: .
    autoplan:
      enabled: true
      when_modified:
        - "db/db1/*.tf"
        - "db/db1/config/*.tfvars"
        - "db/db1/env/*/*"
    terraform_version: v1.6.6
    workflow: production_workflow
    apply_requirements:
      - approved
      - mergeable
workflows:
  production_workflow:
    plan:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"  
            echo "Planning project: $PROJECT_NAME in $APP_DIR"
            rm -rf "$APP_DIR/.terraform" "$APP_DIR/.terraform.lock.hcl"
            terraform -chdir="$APP_DIR" init -backend-config=env/production/prod.conf -reconfigure -lock=false -input=false
            terraform -chdir="$APP_DIR" plan -var-file=config/production.tfvars -lock-timeout=10m -out="$PLANFILE"
    apply:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"
            echo "Applying project: $PROJECT_NAME in $APP_DIR"
            timeout 600 terraform -chdir="$APP_DIR" apply -input=false -auto-approve "$PLANFILE"

  staging_workflow:
    plan:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"
            echo "Planning project: $PROJECT_NAME in $APP_DIR"
            rm -rf "$APP_DIR/.terraform" "$APP_DIR/.terraform.lock.hcl"
            terraform -chdir="$APP_DIR" init -backend-config=env/staging/stage.conf -reconfigure -lock=false -input=false
            terraform -chdir="$APP_DIR" plan -var-file=config/stage.tfvars -lock-timeout=10m -out="$PLANFILE"
    apply:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"
            echo "Applying project: $PROJECT_NAME in $APP_DIR"
            timeout 600 terraform -chdir="$APP_DIR" apply -input=false -auto-approve "$PLANFILE"

  helia_workflow:
    plan:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"
            echo "Planning project: $PROJECT_NAME in $APP_DIR"
            rm -rf "$APP_DIR/.terraform" "$APP_DIR/.terraform.lock.hcl"
            terraform -chdir="$APP_DIR" init -backend-config=env/helia/helia.conf -reconfigure -lock=false -input=false
            terraform -chdir="$APP_DIR" plan -var-file=config/helia.tfvars -lock-timeout=10m -out="$PLANFILE"
    apply:
      steps:
        - run: |
            APP_DIR=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1"/"$2}')
            PLANFILE="tfplan"
            echo "Applying project: $PROJECT_NAME in $APP_DIR"
            timeout 600 terraform -chdir="$APP_DIR" apply -input=false -auto-approve "$PLANFILE"
