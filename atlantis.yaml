version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - name: apps
    dir: application
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "**/*.tf"
    workflow: multi-env
    apply_requirements: []

workflows:
  multi-env:
    plan:
      steps:
        - run: |
            set -euo pipefail
            # We're running inside the 'application' directory (project dir), but the scripts live in the repo root.
            # Call the scripts in the parent directory (../). The scripts are repo-root-aware.
            chmod +x ../process-application.sh
            # Pass ATLANTIS_DIR only when non-empty (the pattern ${ATLANTIS_DIR:+...} expands to nothing if empty)
            ../process-application.sh staging ${ATLANTIS_DIR:+${ATLANTIS_DIR}}
            ../process-application.sh production ${ATLANTIS_DIR:+${ATLANTIS_DIR}}
            ../process-application.sh helia ${ATLANTIS_DIR:+${ATLANTIS_DIR}}
    apply:
      steps:
        - run: |
            set -euo pipefail
            chmod +x ../apply-plans.sh
            ../apply-plans.sh staging || true
            ../apply-plans.sh production || true
            ../apply-plans.sh helia || true