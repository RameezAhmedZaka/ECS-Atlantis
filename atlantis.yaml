version: 3
automerge: false 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: [] 

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable] 

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true 
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []     

workflows:
  staging-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            # Parse the app name from the comment
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              # Extract app name after -- in the comment
              if [[ "$COMMENT" =~ atlantis[[:space:]]+plan[[:space:]]+-p[[:space:]]+apps-staging[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              elif [[ "$COMMENT" =~ atlantis[[:space:]]+plan[[:space:]]+--[[:space:]]+-p[[:space:]]+apps-staging[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              # Extract app name after -- in the comment
              if [[ "$COMMENT" =~ atlantis[[:space:]]+apply[[:space:]]+-p[[:space:]]+apps-staging[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              elif [[ "$COMMENT" =~ atlantis[[:space:]]+apply[[:space:]]+--[[:space:]]+-p[[:space:]]+apps-staging[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              if [[ "$COMMENT" =~ atlantis[[:space:]]+plan[[:space:]]+-p[[:space:]]+apps-production[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              if [[ "$COMMENT" =~ atlantis[[:space:]]+apply[[:space:]]+-p[[:space:]]+apps-production[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              if [[ "$COMMENT" =~ atlantis[[:space:]]+plan[[:space:]]+-p[[:space:]]+apps-helia[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            APP_FILTER=""
            if [[ -n "$COMMENT" ]]; then
              if [[ "$COMMENT" =~ atlantis[[:space:]]+apply[[:space:]]+-p[[:space:]]+apps-helia[[:space:]]*--[[:space:]]*([^[:space:]]+) ]]; then
                APP_FILTER="${BASH_REMATCH[1]}"
              fi
            fi
            echo "APP_FILTER: '$APP_FILTER'"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"
