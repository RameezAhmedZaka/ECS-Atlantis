version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - autodiscover:
    path: application
    config_file: main.tf
    autoplan:
      enabled: true
      when_modified:
          # Any change inside that app folder triggers plan for that app/env
        - "*.tf"
        - "config/*.tfvars"
        - "env/**/*.conf"
      # Define environment-specific configurations
    workflow: custom-workflow    

    
workflows:
  custom-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Processing STAGING environment ==="
            chmod +x ./process-application.sh
            # Pass the project directory from Atlantis environment variable
            ./process-application.sh "$ENV" "$ATLANTIS_PROJECT_DIR"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Applying STAGING environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"

  # production-workflow:
  #   plan:
  #     steps:
  #       - run: |
  #           set -euo pipefix
  #           ENV="production"
  #           echo "=== Processing PRODUCTION environment ==="
  #           chmod +x ./process-application.sh
  #           ./process-application.sh "$ENV" "$ATLANTIS_PROJECT_DIR"
  #   apply:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           echo "=== Applying PRODUCTION environment ==="
  #           chmod +x ./apply-plans.sh
  #           ./apply-plans.sh "$ENV"

  # helia-workflow:
  #   plan:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "=== Processing HELIA environment ==="
  #           chmod +x ./process-application.sh
  #           ./process-application.sh "$ENV" "$ATLANTIS_PROJECT_DIR"
  #   apply:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "=== Applying HELIA environment ==="
  #           chmod +x ./apply-plans.sh
  #           ./apply-plans.sh "$ENV"
