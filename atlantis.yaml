---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
  - name: application-rdot-helia
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-production
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-staging
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/staging/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-helia
    dir: db/db1/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-production
    dir: db/db1/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-staging
    dir: db/db1/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/staging/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db2-helia
    dir: db/db2/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db2-production
    dir: db/db2/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db2-staging
    dir: db/db2/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/staging/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db22-helia
    dir: db/db22/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db22-production
    dir: db/db22/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db22-staging
    dir: db/db22/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/staging/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db3-helia
    dir: db/db3/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db3-production
    dir: db/db3/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db3-staging
    dir: db/db3/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/staging/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
workflows:
  multi_env_workflow:
    plan:
      steps:  
        - run: |
            PLANFILE="plan.tfplan"
            DESTROY_FLAG=""
            if [[ "" =~ -destroy ]]; then
              echo "Destroy IS DIABLED"
              DESTROY_FLAG="-destroy"
            else
              echo "Normal plan"
            fi

            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
            esac

            echo "Planning for environment: $ENV"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"
            echo "Destroy flag: $DESTROY_FLAG"

            cd "$PROJECT_DIR"

            if [ -f "$BACKEND_CONFIG" ]; then
              timeout 300 terraform init                 -backend-config="$BACKEND_CONFIG"                 -input=false -reconfigure > /dev/null 2>&1
            else
              terraform init -input=false -reconfigure
            fi

            if [ -f "$VAR_FILE" ]; then
              timeout 300 terraform plan $DESTROY_FLAG                          -var-file="$VAR_FILE"                          -out="$PLANFILE"
            else
              terraform plan $DESTROY_FLAG -out="$PLANFILE"
            fi

    apply:
      steps:
        - run: |
            PLANFILE="plan.tfplan"

            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
            esac

            echo "Applying for environment: $ENV"

            cd "$PROJECT_DIR"

            if [ -f "$BACKEND_CONFIG" ]; then
              timeout 300 terraform init                 -backend-config="$BACKEND_CONFIG"                 -input=false -reconfigure > /dev/null 2>&1
            else
              terraform init -input=false -reconfigure > /dev/null 2>&1
            fi

            # Apply the plan if it exists, otherwise do a raw apply with var-file
            if [ -f "$PLANFILE" ]; then
              timeout 600 terraform apply -input=false -auto-approve "$PLANFILE" || {
                echo "Apply failed for $PLANFILE"
              }
            else
              timeout 600 terraform apply -var-file="$VAR_FILE" -input=false -auto-approve || {
                echo "Apply failed for $PROJECT_DIR"
              }
            fi
