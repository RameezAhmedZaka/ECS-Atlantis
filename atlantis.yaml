# repos:
#   - id: /.*/
#     pre_workflow_hooks:
#       - run: |
#           echo "Generating atlantis.yaml dynamically..."
#           ./scripts/generate_atlantis_yaml.sh
#         description: Generating atlantis.yaml for Terraform
#         shell: bash
#         shellArgs: -cv


# version: 3
# automerge: false
# parallel_plan: true
# parallel_apply: true

# # Enable auto-discovery for Terraform projects
# autodiscover:
#   mode: enabled

# # Default project configuration applied to all discovered projects
# default_project_config:
#   terraform_version: v1.5.0
#   apply_requirements: [mergeable]
#   autoplan:
#     enabled: true
#   workflow: default

# workflows:
#   default:
#     plan:
#       steps:
#         - init
#         - plan
#     apply:
#       steps:
#         - apply
# version: 3
# automerge: true 
# parallel_plan: false  
# parallel_apply: false  

# projects:
#   - name: apps-staging
#     dir: .
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true  
#       when_modified:
#         - "application/**"
#     workflow: staging-workflow
#     apply_requirements: [] 

#   - name: apps-production
#     dir: .
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true  
#       when_modified:
#         - "application/**"
#     workflow: production-workflow
#     apply_requirements: [approved, mergeable] 

#   - name: apps-helia
#     dir: .
#     terraform_version: v1.6.6  
#     autoplan:
#       enabled: true 
#       when_modified:
#         - "application/**"
#     workflow: helia-workflow
#     apply_requirements: [approved, mergeable]     

# workflows:
#   staging-workflow:
#     plan:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: 
#             command: |
#               set -euo pipefail
#               ENV="staging"
#               PROJECT="apps-staging"
#               echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#               chmod +x ./scripts/process-application.sh
#               ./scripts/process-application.sh "$ENV" "$APP_FILTER"
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             PROJECT="apps-staging"
#             CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
#             PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
#             if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
#               # Read changed apps using POSIX-compliant method
#               CHANGED_APPS=""
#               APP_COUNT=0
              
#               while IFS= read -r app; do
#                 if [ -n "$app" ]; then
#                   CHANGED_APPS="${CHANGED_APPS} $app"
#                   APP_COUNT=$((APP_COUNT + 1))
#                 fi
#               done < "$CHANGED_APPS_LIST"
              
#               # Trim leading space
#               CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
#               # Write custom output
#               CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
#               {
#                 echo "## ðŸš€ Staging Environment"
#                 echo "Plan generated for $APP_COUNT application(s) with changes"
#                 echo ""
                
#                 if [ $APP_COUNT -gt 0 ]; then
#                   echo "### Changed Applications:"
#                   for app in $CHANGED_APPS; do
#                     echo "- **$app**"  
#                   done
#                   echo ""
#                   echo '```'
#                   echo ""
#                   echo "â–¶ï¸ To apply individual applications:"
#                   echo ""
#                   for app in $CHANGED_APPS; do
#                     echo "**$app**"
#                     echo '```'
#                     echo "atlantis apply -p apps-staging -- $app"
#                     echo '```'
#                     echo ""
#                   done
#                   echo "â© To apply **all $APP_COUNT applications**:"
#                   echo ""
#                   echo '```'
#                   echo "atlantis apply -p apps-staging"
#                   echo '```'
#                 fi
                
#                 echo "ðŸ” To re-plan:"
#                 echo ""
#                 echo '```'
#                 echo "atlantis plan -p apps-staging"
#                 echo ""
#               } > "$CUSTOM_OUTPUT_FILE"
              
#               cat "$CUSTOM_OUTPUT_FILE"
              
#             else
#               echo "## âœ… No Infrastructure Changes"
#               echo "No changes detected in any application. Your infrastructure matches the configuration."
#               echo ""
#               echo "If you expected changes, ensure your modifications affect the Terraform configuration."
#             fi

#     apply:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/apply-plans.sh
#             ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"  

#   production-workflow:                   
#     plan:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="production"
#             echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/process-application.sh
#             ./scripts/process-application.sh "$ENV" "$APP_FILTER"
#         - run: |
#             set -euo pipefail
#             ENV="production"
#             PROJECT="apps-production"
#             CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
#             PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
#             if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
#               # Read changed apps using POSIX-compliant method
#               CHANGED_APPS=""
#               APP_COUNT=0
              
#               while IFS= read -r app; do
#                 if [ -n "$app" ]; then
#                   CHANGED_APPS="${CHANGED_APPS} $app"
#                   APP_COUNT=$((APP_COUNT + 1))
#                 fi
#               done < "$CHANGED_APPS_LIST"
              
#               # Trim leading space
#               CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
#               # Write custom output
#               CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
#               {
#                 echo "## ðŸš€ Production Environment"
#                 echo "Plan generated for $APP_COUNT application(s) with changes"
#                 echo ""
                
#                 if [ $APP_COUNT -gt 0 ]; then
#                   echo "### Changed Applications:"
#                   for app in $CHANGED_APPS; do
#                     echo "- **$app**"  
#                   done
#                   echo ""
#                   echo '```'
#                   echo ""
#                   echo "â–¶ï¸ To apply individual applications:"
#                   echo ""
#                   for app in $CHANGED_APPS; do
#                     echo "**$app**"
#                     echo '```'
#                     echo "atlantis apply -p apps-production -- $app"
#                     echo '```'
#                     echo ""
#                   done
#                   echo "â© To apply **all $APP_COUNT applications**:"
#                   echo ""
#                   echo '```'
#                   echo "atlantis apply -p apps-production"
#                   echo '```'
#                 fi
                
#                 echo "ðŸ” To re-plan:"
#                 echo ""
#                 echo '```'
#                 echo "atlantis plan -p apps-production"
#                 echo ""
#               } > "$CUSTOM_OUTPUT_FILE"
              
#               cat "$CUSTOM_OUTPUT_FILE"
              
#             else
#               echo "## âœ… No Infrastructure Changes"
#               echo "No changes detected in any application. Your infrastructure matches the configuration."
#               echo ""
#               echo "If you expected changes, ensure your modifications affect the Terraform configuration."
#             fi


#     apply:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="production"
#             echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/apply-plans.sh
#             ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

#   helia-workflow:
#     plan:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="helia"
#             echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/process-application.sh
#             ./scripts/process-application.sh "$ENV" "$APP_FILTER"
#         - run: |
#             set -euo pipefail
#             ENV="helia"
#             PROJECT="apps-helia"
#             CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
#             PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
#             if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
#               # Read changed apps using POSIX-compliant method
#               CHANGED_APPS=""
#               APP_COUNT=0
              
#               while IFS= read -r app; do
#                 if [ -n "$app" ]; then
#                   CHANGED_APPS="${CHANGED_APPS} $app"
#                   APP_COUNT=$((APP_COUNT + 1))
#                 fi
#               done < "$CHANGED_APPS_LIST"
              
#               # Trim leading space
#               CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
#               # Write custom output
#               CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
#               {
#                 echo "## ðŸš€ Helia Environment"
#                 echo "Plan generated for $APP_COUNT application(s) with changes"
#                 echo ""
                
#                 if [ $APP_COUNT -gt 0 ]; then
#                   echo "### Changed Applications:"
#                   for app in $CHANGED_APPS; do
#                     echo "- **$app**"  
#                   done
#                   echo ""
#                   echo '```'
#                   echo ""
#                   echo "â–¶ï¸ To apply individual applications:"
#                   echo ""
#                   for app in $CHANGED_APPS; do
#                     echo "**$app**"
#                     echo '```'
#                     echo "atlantis apply -p apps-helia -- $app"
#                     echo '```'
#                     echo ""
#                   done
#                   echo "â© To apply **all $APP_COUNT applications**:"
#                   echo ""
#                   echo '```'
#                   echo "atlantis apply -p apps-helia"
#                   echo '```'
#                 fi
                
#                 echo "ðŸ” To re-plan:"
#                 echo ""
#                 echo '```'
#                 echo "atlantis plan -p apps-helia"
#                 echo ""
#               } > "$CUSTOM_OUTPUT_FILE"
              
#               cat "$CUSTOM_OUTPUT_FILE"
              
#             else
#               echo "## âœ… No Infrastructure Changes"
#               echo "No changes detected in any application. Your infrastructure matches the configuration."
#               echo ""
#               echo "If you expected changes, ensure your modifications affect the Terraform configuration."
#             fi

#     apply :      
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="helia"
#             echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/apply-plans.sh
#             ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"




# version: 3
# automerge: true 
# parallel_plan: false  
# parallel_apply: false  

# projects:
#   - name: apps-staging
#     dir: .
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true  
#       when_modified:
#         - "application/**"
#     workflow: staging-workflow
#     apply_requirements: [] 

  # - name: apps-production
  #   dir: .
  #   terraverform_version: v1.6.6
  #   autoplan:
  #     enabled: true  
  #     when_modified:
  #       - "application/**"
  #   workflow: production-workflow
  #   apply_requirements: [approved, mergeable] 

  # - name: apps-helia
  #   dir: .
  #   terraform_version: v1.6.6  
  #   autoplan:
  #     enabled: true 
  #     when_modified:
  #       - "application/**"
  #   workflow: helia-workflow
  #   apply_requirements: [approved, mergeable]     

# workflows:
#   staging-workflow:
#     plan:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: 
#             command: |
#               set -euo pipefail
#               ENV="staging"
#               echo "ðŸš€ Initializing Terraform for $ENV environment..."
#               chmod +x ./scripts/init-terraform.sh
#               ./scripts/init-terraform.sh "$ENV" "$APP_FILTER"
#             output: hide  
#         - run: 
#             command: |
#               set -euo pipefail
#               ENV="staging"
#               PROJECT="apps-staging"
#               echo "ðŸ“‹ Planning Terraform changes for $ENV..."
#               chmod +x ./scripts/process-application.sh
#               ./scripts/process-application.sh "$ENV" "$APP_FILTER"
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             PROJECT="apps-staging"
#             CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
#             PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
#             if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
#               # Read changed apps using POSIX-compliant method
#               CHANGED_APPS=""
#               APP_COUNT=0
              
#               while IFS= read -r app; do
#                 if [ -n "$app" ]; then
#                   CHANGED_APPS="${CHANGED_APPS} $app"
#                   APP_COUNT=$((APP_COUNT + 1))
#                 fi
#               done < "$CHANGED_APPS_LIST"
              
#               # Trim leading space
#               CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
#               # Write custom output
#               CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
#               {
#                 echo "## ðŸš€ Staging Environment"
#                 echo "Plan generated for $APP_COUNT application(s) with changes"
#                 echo ""
                
#                 if [ $APP_COUNT -gt 0 ]; then
#                   echo "### Changed Applications:"
#                   for app in $CHANGED_APPS; do
#                     echo "- **$app**"  
#                   done
#                   echo ""
#                   echo '```'
#                   echo ""
#                   echo "â–¶ï¸ To apply individual applications:"
#                   echo ""
#                   for app in $CHANGED_APPS; do
#                     echo "**$app**"
#                     echo '```'
#                     echo "atlantis apply -p apps-staging -- $app"
#                     echo '```'
#                     echo ""
#                   done
#                   echo "â© To apply **all $APP_COUNT applications**:"
#                   echo ""
#                   echo '```'
#                   echo "atlantis apply -p apps-staging"
#                   echo '```'
#                 fi
                
#                 echo "ðŸ” To re-plan:"
#                 echo ""
#                 echo '```'
#                 echo "atlantis plan -p apps-staging"
#                 echo ""
#               } > "$CUSTOM_OUTPUT_FILE"
              
#               cat "$CUSTOM_OUTPUT_FILE"
              
#             else
#               echo "## âœ… No Infrastructure Changes"
#               echo "No changes detected in any application. Your infrastructure matches the configuration."
#               echo ""
#               echo "If you expected changes, ensure your modifications affect the Terraform configuration."
#             fi

#     apply:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/apply-plans.sh
#             ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"  

  # production-workflow:                   
  #   plan:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: 
  #           command: |
  #             set -euo pipefail
  #             ENV="production"
  #             echo "ðŸš€ Initializing Terraform for $ENV environment..."
  #             chmod +x ./scripts/init-terraform.sh
  #             ./scripts/init-terraform.sh "$ENV" "$APP_FILTER"
  #       - run: 
  #           command: |
  #             set -euo pipefail
  #             ENV="production"
  #             PROJECT="apps-production"
  #             echo "ðŸ“‹ Planning Terraform changes for $ENV..."
  #             chmod +x ./scripts/process-application.sh
  #             ./scripts/process-application.sh "$ENV" "$APP_FILTER"
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           PROJECT="apps-production"
  #           CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
  #           PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
  #           if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
  #             # Read changed apps using POSIX-compliant method
  #             CHANGED_APPS=""
  #             APP_COUNT=0
              
  #             while IFS= read -r app; do
  #               if [ -n "$app" ]; then
  #                 CHANGED_APPS="${CHANGED_APPS} $app"
  #                 APP_COUNT=$((APP_COUNT + 1))
  #               fi
  #             done < "$CHANGED_APPS_LIST"
              
  #             # Trim leading space
  #             CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
  #             # Write custom output
  #             CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
  #             {
  #               echo "## ðŸš€ Production Environment"
  #               echo "Plan generated for $APP_COUNT application(s) with changes"
  #               echo ""
                
  #               if [ $APP_COUNT -gt 0 ]; then
  #                 echo "### Changed Applications:"
  #                 for app in $CHANGED_APPS; do
  #                   echo "- **$app**"  
  #                 done
  #                 echo ""
  #                 echo '```'
  #                 echo ""
  #                 echo "â–¶ï¸ To apply individual applications:"
  #                 echo ""
  #                 for app in $CHANGED_APPS; do
  #                   echo "**$app**"
  #                   echo '```'
  #                   echo "atlantis apply -p apps-production -- $app"
  #                   echo '```'
  #                   echo ""
  #                 done
  #                 echo "â© To apply **all $APP_COUNT applications**:"
  #                 echo ""
  #                 echo '```'
  #                   echo "atlantis apply -p apps-production"
  #                   echo '```'
  #               fi
                
  #               echo "ðŸ” To re-plan:"
  #               echo ""
  #               echo '```'
  #               echo "atlantis plan -p apps-production"
  #               echo ""
  #             } > "$CUSTOM_OUTPUT_FILE"
              
  #             cat "$CUSTOM_OUTPUT_FILE"
              
  #           else
  #             echo "## âœ… No Infrastructure Changes"
  #             echo "No changes detected in any application. Your infrastructure matches the configuration."
  #             echo ""
  #             echo "If you expected changes, ensure your modifications affect the Terraform configuration."
  #           fi

  #   apply:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/apply-plans.sh
  #           ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  # helia-workflow:
  #   plan:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: 
  #           command: |
  #             set -euo pipefail
  #             ENV="helia"
  #             echo "ðŸš€ Initializing Terraform for $ENV environment..."
  #             chmod +x ./scripts/init-terraform.sh
  #             ./scripts/init-terraform.sh "$ENV" "$APP_FILTER"
  #       - run: 
  #           command: |
  #             set -euo pipefail
  #             ENV="helia"
  #             PROJECT="apps-helia"
  #             echo "ðŸ“‹ Planning Terraform changes for $ENV..."
  #             chmod +x ./scripts/process-application.sh
  #             ./scripts/process-application.sh "$ENV" "$APP_FILTER"
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           PROJECT="apps-helia"
  #           CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
  #           PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
  #           if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
  #             # Read changed apps using POSIX-compliant method
  #             CHANGED_APPS=""
  #             APP_COUNT=0
              
  #             while IFS= read -r app; do
  #               if [ -n "$app" ]; then
  #                 CHANGED_APPS="${CHANGED_APPS} $app"
  #                 APP_COUNT=$((APP_COUNT + 1))
  #               fi
  #             done < "$CHANGED_APPS_LIST"
              
  #             # Trim leading space
  #             CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
  #             # Write custom output
  #             CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
  #             {
  #               echo "## ðŸš€ Helia Environment"
  #               echo "Plan generated for $APP_COUNT application(s) with changes"
  #               echo ""
                
  #               if [ $APP_COUNT -gt 0 ]; then
  #                 echo "### Changed Applications:"
  #                 for app in $CHANGED_APPS; do
  #                   echo "- **$app**"  
  #                 done
  #                 echo ""
  #                 echo '```'
  #                 echo ""
  #                 echo "â–¶ï¸ To apply individual applications:"
  #                 echo ""
  #                 for app in $CHANGED_APPS; do
  #                   echo "**$app**"
  #                   echo '```'
  #                   echo "atlantis apply -p apps-helia -- $app"
  #                   echo '```'
  #                   echo ""
  #                 done
  #                 echo "â© To apply **all $APP_COUNT applications**:"
  #                 echo ""
  #                 echo '```'
  #                 echo "atlantis apply -p apps-helia"
  #                 echo '```'
  #               fi
                
  #               echo "ðŸ” To re-plan:"
  #               echo ""
  #               echo '```'
  #               echo "atlantis plan -p apps-helia"
  #               echo ""
  #             } > "$CUSTOM_OUTPUT_FILE"
              
  #             cat "$CUSTOM_OUTPUT_FILE"
              
  #           else
  #             echo "## âœ… No Infrastructure Changes"
  #             echo "No changes detected in any application. Your infrastructure matches the configuration."
  #             echo ""
  #             echo "If you expected changes, ensure your modifications affect the Terraform configuration."
  #           fi

  #   apply:      
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/apply-plans.sh
  #           ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"