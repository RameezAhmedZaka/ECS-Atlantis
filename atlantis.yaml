version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - name: app-staging
    dir: application/{{ .ProjectName }}
    workspace: staging
    terraform_version: v1.6.6
    autoplan:
      enabled: false  # Disable autoplan for manual control
    workflow: staging-workflow
    apply_requirements: []

  - name: app-production  
    dir: application/{{ .ProjectName }}
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: false
    workflow: production-workflow
    apply_requirements: []

  - name: app-helia
    dir: application/{{ .ProjectName }}
    workspace: helia
    terraform_version: v1.6.6
    autoplan:
      enabled: false
    workflow: helia-workflow
    apply_requirements: []

workflows:
  staging-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Planning $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./process-application.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Applying $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./apply-plans.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"

  production-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Planning $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./process-application.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Applying $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./apply-plans.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"

  helia-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "=== Planning $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./process-application.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "=== Applying $ENV for ${ATLANTIS_PROJECT_NAME} ==="
            ./apply-plans.sh "$ENV" "${ATLANTIS_PROJECT_NAME}"