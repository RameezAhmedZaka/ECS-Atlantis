
version: 3
automerge: true
parallel_plan: true
parallel_apply: true

projects:
  - name: apps-staging
    dir: .
    workspace: staging
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: matrix-tf

  - name: apps-production
    dir: .
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: matrix-tf

workflows:
  matrix-tf:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="${ATLANTIS_WORKSPACE}"

            # Collect unique application dirs that changed
            mapfile -t dirs < <(printf "%s\n" $CHANGED_FILES \
              | grep -E "^application/[^/]+/" || true \
              | awk -F/ "{print \$1\"/\"\$2}" \
              | sort -u)

            if [[ ${#dirs[@]} -eq 0 ]]; then
              echo "No changed application directories."
              exit 0
            fi

            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            : > "$PLANLIST"

            for d in "${dirs[@]}"; do
              if [[ -f "$d/main.tf" ]]; then
                APP_NAME=$(basename "$d")
                echo "=== Planning $APP_NAME ($ENV) ==="
                
                # Set backend config and var-file based on environment
                case "$ENV" in
                  "production")
                    BACKEND_CONFIG="$d/env/production/prod.con"
                    VAR_FILE="$d/config/production.tfvars"
                    ;;
                  "staging")
                    BACKEND_CONFIG="$d/env/staging/stage.con"
                    VAR_FILE="$d/config/stage.tfvars"
                    ;;
                  *)
                    echo "Unknown environment: $ENV"
                    exit 1
                    ;;
                esac

                # Initialize with backend config
                if [[ -f "$BACKEND_CONFIG" ]]; then
                  echo "Using backend config: $BACKEND_CONFIG"
                  terraform -chdir="$d" init -upgrade -backend-config="$BACKEND_CONFIG"
                else
                  echo "⚠️  Backend config not found: $BACKEND_CONFIG"
                  echo "Proceeding with default init"
                  terraform -chdir="$d" init -upgrade
                fi

                # Workspace management
                if ! terraform -chdir="$d" workspace select "$ENV" 2>/dev/null; then
                  echo "Creating new workspace: $ENV"
                  terraform -chdir="$d" workspace new "$ENV"
                fi

                PLAN="/tmp/$(echo "$d" | tr "/" "_")_${ENV}.tfplan"

                # Plan with var-file
                if [[ -f "$VAR_FILE" ]]; then
                  echo "Using var-file: $VAR_FILE"
                  terraform -chdir="$d" plan -input=false -lock-timeout=20m -var-file="$VAR_FILE" -out="$PLAN"
                else
                  echo "⚠️  Var file not found: $VAR_FILE"
                  echo "Proceeding without -var-file"
                  terraform -chdir="$d" plan -input=false -lock-timeout=20m -out="$PLAN"
                fi

                echo "$PLAN" >> "$PLANLIST"
                echo "✓ Successfully planned $APP_NAME for $ENV"
              else
                echo "Skipping $d (no main.tf)"
              fi
            done

            echo "Plan files recorded in $PLANLIST"

    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="${ATLANTIS_WORKSPACE}"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"

            if [[ ! -f "$PLANLIST" ]]; then
              echo "No plan list found - nothing to apply"
              exit 0
            fi

            if [[ ! -s "$PLANLIST" ]]; then
              echo "No plan files to apply."
              exit 0
            fi

            while IFS= read -r PLAN; do
              if [[ -f "$PLAN" ]]; then
                echo "=== Applying $PLAN ==="
                terraform apply -input=false -auto-approve "$PLAN"
                echo "✓ Successfully applied $PLAN"
                
                # Clean up plan file after successful apply
                rm -f "$PLAN"
              else
                echo "⚠️  Plan file not found: $PLAN"
              fi
            done < "$PLANLIST"
            
            # Clean up plan list after all applies
            rm -f "$PLANLIST"


            

# version: 3
# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: ./terraform_env.sh
#             output: show
#         - init: {}
#         - plan: {}
#     apply:
#       steps:
#         - apply: {}

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: ./terraform_env.sh
#             output: show
#         - init: {}
#         - plan: {}
#     apply:
#       steps:
#         - apply: {}






  # - name: application
  #   dir: application
  #   workspace: stage
  #   workflow: dev-workflow
  #   apply_requirements: []
  #   autoplan:
  #     when_modified: ["*.tf", "config/*.tfvars", "modules/**/*.tf", "**/*.tf"]
  #     enabled: true

  # - name: application-prod
  #   dir: application
  #   workspace: production
  #   workflow: prod-workflow
  #   apply_requirements: []
  #   autoplan:
  #     when_modified: ["*.tf", "config/*.tfvars", "modules/**/*.tf", "**/*.tf"]
  #     enabled: true

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Processing app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform init -backend-config="env/staging/stage.conf"
#                 terraform plan -var-file="config/stage.tfvars" -out="$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done
#     apply:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Applying app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform apply -var-file="config/stage.tfvars" "$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done

#   prod-workflow:
#     plan:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Processing app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform init -backend-config="env/production/prod.conf"
#                 terraform plan -var-file="config/production.tfvars" -out="$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done
#     apply:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Applying app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform apply -var-file="config/production.tfvars" "$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done

####

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d init -backend-config="$d/env/staging/stage.conf"
#                 terraform -chdir=$d plan -var-file="$d/config/stage.tfvars"
#               done
#     apply:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d apply -var-file="$d/config/stage.tfvars" -auto-approve
#               done

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d init -backend-config="$d/env/production/prod.conf"
#                 terraform -chdir=$d plan -var-file="$d/config/production.tfvars"
#               done
#     apply:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d apply -var-file="$d/config/production.tfvars" -auto-approve
#               done

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls
#         - init:
#             extra_args: ["-backend-config=env/staging/stage.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/stage.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/stage.tfvars"]

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls      
#         - init:
#             extra_args: ["-backend-config=env/production/prod.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/production.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/production.tfvars"]


  # - name: databases
  #   dir: databases/*
  #   autoplan:
  #     when_modified: ["databases/**/*.tf", "databases/**/config/*.tfvars", "databases/**/env/**/*.conf"]
  #     enabled: true


# version: 3
# automerge: true
# parallel_plan: true
# parallel_apply: true

# projects:
#   - name: apps-staging
#     dir: .
#     workspace: staging
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true
#       when_modified:
#         - "application/**"
#     workflow: matrix-tf

#   - name: apps-production
#     dir: .
#     workspace: production
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true
#       when_modified:
#         - "application/**"
#     workflow: matrix-tf

# workflows:
#   matrix-tf:
#     plan:
#       steps:
#         - run:
#             shell: bash
#             command: |
#               set -euo pipefail
#               ENV="${ATLANTIS_WORKSPACE}"

#               # Collect changed application directories
#               mapfile -t dirs < <(
#                 printf "%s\n" $CHANGED_FILES \
#                   | grep -E "^application/[^/]+/" \
#                   | awk -F/ '{print $1"/"$2}' \
#                   | sort -u
#               )

#               if [[ ${#dirs[@]} -eq 0 ]]; then
#                 echo "No changed application directories."
#                 exit 0
#               fi

#               PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
#               : > "$PLANLIST"

#               for d in "${dirs[@]}"; do
#                 if [[ -f "$d/main.tf" ]]; then
#                   echo "=== Initializing $d ($ENV) ==="

#                   # Initialize Terraform with backend config
#                   terraform -chdir="$d" init -upgrade -backend-config="env/${ENV}/${ENV}.conf"

#                   # Select or create workspace
#                   terraform -chdir="$d" workspace select "$ENV" \
#                     || terraform -chdir="$d" workspace new "$ENV"

#                   TFVARS="$d/config/${ENV}.tfvars"
#                   PLAN="/tmp/$(echo "$d" | tr "/" "_")_${ENV}.tfplan"

#                   echo "=== Planning $d ($ENV) ==="
#                   if [[ -f "$TFVARS" ]]; then
#                     terraform -chdir="$d" plan -input=false -lock-timeout=20m -var-file="$TFVARS" -out="$PLAN"
#                   else
#                     echo "No tfvars for $d — proceeding without -var-file"
#                     terraform -chdir="$d" plan -input=false -lock-timeout=20m -out="$PLAN"
#                   fi

#                   echo "$PLAN" >> "$PLANLIST"
#                 else
#                   echo "Skipping it $d (no main.tf)"
#                 fi
#               done

#               echo "Plan files recorded in $PLANLIST"

#     apply:
#       steps:
#         - run:
#             shell: bash
#             command: |
#               set -euo pipefail
#               ENV="${ATLANTIS_WORKSPACE}"
#               PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"

#               if [[ ! -s "$PLANLIST" ]]; then
#                 echo "No plan files to apply."
#                 exit 0
#               fi

#               while IFS= read -r PLAN; do
#                 echo "=== Applying $PLAN ==="
#                 terraform apply -input=false "$PLAN"
#               done < "$PLANLIST"
