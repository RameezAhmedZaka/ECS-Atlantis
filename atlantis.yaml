version: 3
automerge: true 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: [] 

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: 
            command: |
              set -euo pipefail
              ENV="staging"
              PROJECT="apps-staging"
              echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER"
        - run: |
            set -euo pipefail
            ENV="staging"
            PROJECT="apps-staging"
            CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            # Initialize counters
            TOTAL_APPS=0
            CHANGED_COUNT=0
            UP_TO_DATE_COUNT=0
            
            # Find all applications
            dirs=$(find application -type f -name "main.tf" | sed 's|/main.tf||' | sort -u)
            
            # Count total applications (considering filter if any)
            if [ -n "$APP_FILTER" ]; then
              # With filter, only count matching apps
              TOTAL_APPS=$(echo "$dirs" | while IFS= read -r d; do
                APP_NAME=$(basename "$d")
                if [ "$APP_NAME" = "$APP_FILTER" ]; then
                  echo "$APP_NAME"
                fi
              done | wc -l | tr -d ' ')
            else
              # Without filter, count all apps
              TOTAL_APPS=$(echo "$dirs" | wc -l | tr -d ' ')
            fi
            
            # Count changed applications
            if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
              CHANGED_COUNT=$(wc -l < "$CHANGED_APPS_LIST" | tr -d ' ')
            fi
            
            UP_TO_DATE_COUNT=$((TOTAL_APPS - CHANGED_COUNT))
            
            # Create custom output - ONLY show up-to-date applications
            CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
            
            {
              echo "## ðŸš€ Staging Environment - Infrastructure Status"
              
              if [ $UP_TO_DATE_COUNT -gt 0 ]; then
                echo "### âœ… Up-to-Date Applications ($UP_TO_DATE_COUNT):"
                
                # Show up-to-date applications
                echo "$dirs" | while IFS= read -r d; do
                  if [ -f "$d/main.tf" ]; then
                    APP_NAME=$(basename "$d")
                    
                    # Apply filter if specified
                    if [ -n "$APP_FILTER" ] && [ "$APP_NAME" != "$APP_FILTER" ]; then
                      continue
                    fi
                    
                    # Check if this app is in changed list
                    IS_CHANGED=false
                    if [ -f "$CHANGED_APPS_LIST" ]; then
                      while IFS= read -r changed_app; do
                        if [ "$changed_app" = "$APP_NAME" ]; then
                          IS_CHANGED=true
                          break
                        fi
                      done < "$CHANGED_APPS_LIST"
                    fi
                    
                    if [ "$IS_CHANGED" = "false" ]; then
                      echo "- **$APP_NAME** - Infrastructure is up-to-date"
                    fi
                  fi
                done
              fi
              
              # Only show changed apps section if there are changes
              if [ $CHANGED_COUNT -gt 0 ]; then
                echo ""
                echo "### ðŸ”„ Applications with Changes ($CHANGED_COUNT):"
                echo "*Changes detected - review plan details above*"
                
                echo ""
                echo "â–¶ï¸ To apply changes:"
                echo '```'
                if [ -n "$APP_FILTER" ]; then
                  echo "atlantis apply -p apps-staging -- $APP_FILTER"
                else
                  echo "atlantis apply -p apps-staging"
                fi
                echo '```'
              fi
              
              echo ""
              echo "---"
              echo "**Summary**: $UP_TO_DATE_COUNT up-to-date, $CHANGED_COUNT with changes out of $TOTAL_APPS total applications"
              
            } > "$CUSTOM_OUTPUT_FILE"
            
            cat "$CUSTOM_OUTPUT_FILE"
            
        # This step suppresses Atlantis' default plan output
        - show: 
            # Empty show step to override default plan output
            # This will be replaced with our custom output above

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"




# version: 3
# automerge: true 
# parallel_plan: false  
# parallel_apply: false  

# projects:
#   - name: apps-staging
#     dir: .
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true  
#       when_modified:
#         - "application/**"
#     workflow: staging-workflow
#     apply_requirements: [] 

  # - name: apps-production
  #   dir: .
  #   terraform_version: v1.6.6
  #   autoplan:
  #     enabled: true  
  #     when_modified:
  #       - "application/**"
  #   workflow: production-workflow
  #   apply_requirements: [approved, mergeable] 

  # - name: apps-helia
  #   dir: .
  #   terraform_version: v1.6.6  
  #   autoplan:
  #     enabled: true 
  #     when_modified:
  #       - "application/**"
  #   workflow: helia-workflow
  #   apply_requirements: [approved, mergeable]     

# workflows:
#   staging-workflow:
#     plan:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: 
#             command: |
#               set -euo pipefail
#               ENV="staging"
#               PROJECT="apps-staging"
#               echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#               chmod +x ./scripts/process-application.sh
#               ./scripts/process-application.sh "$ENV" "$APP_FILTER"
#             # output: hide  
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             PROJECT="apps-staging"
#             CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
#             PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
#             if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
#               # Read changed apps using POSIX-compliant method
#               CHANGED_APPS=""
#               APP_COUNT=0
              
#               while IFS= read -r app; do
#                 if [ -n "$app" ]; then
#                   CHANGED_APPS="${CHANGED_APPS} $app"
#                   APP_COUNT=$((APP_COUNT + 1))
#                 fi
#               done < "$CHANGED_APPS_LIST"
              
#               # Trim leading space
#               CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
#               # Write custom output
#               CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
#               {
#                 echo "## ðŸš€ Staging Environment"
#                 echo "Plan generated for $APP_COUNT application(s) with changes"
#                 echo ""
                
#                 if [ $APP_COUNT -gt 0 ]; then
#                   echo "### Changed Applications:"
#                   for app in $CHANGED_APPS; do
#                     echo "- **$app**"  
#                   done
#                   echo ""
#                   echo '```'
#                   echo ""
#                   echo "â–¶ï¸ To apply individual applications:"
#                   echo ""
#                   for app in $CHANGED_APPS; do
#                     echo "**$app**"
#                     echo '```'
#                     echo "atlantis apply -p apps-staging -- $app"
#                     echo '```'
#                     echo ""
#                   done
#                   echo "â© To apply **all $APP_COUNT applications**:"
#                   echo ""
#                   echo '```'
#                   echo "atlantis apply -p apps-staging"
#                   echo '```'
#                 fi
                
#                 echo "ðŸ” To re-plan:"
#                 echo ""
#                 echo '```'
#                 echo "atlantis plan -p apps-staging"
#                 echo ""
#               } > "$CUSTOM_OUTPUT_FILE"
              
#               cat "$CUSTOM_OUTPUT_FILE"
              
#             else
#               echo "## âœ… No Infrastructure Changes"
#               echo "No changes detected in any application. Your infrastructure matches the configuration."
#               echo ""
#               echo "If you expected changes, ensure your modifications affect the Terraform configuration."
#             fi

#     apply:
#       steps:
#         - env:
#             name: APP_FILTER
#             command: echo "$COMMENT_ARGS" | tr -d '\\'
#         - run: |
#             set -euo pipefail
#             ENV="staging"
#             echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
#             chmod +x ./scripts/apply-plans.sh
#             ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"  

  # production-workflow:                   
  #   plan:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/process-application.sh
  #           ./scripts/process-application.sh "$ENV" "$APP_FILTER"
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           PROJECT="apps-production"
  #           CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
  #           PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
  #           if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
  #             # Read changed apps using POSIX-compliant method
  #             CHANGED_APPS=""
  #             APP_COUNT=0
              
  #             while IFS= read -r app; do
  #               if [ -n "$app" ]; then
  #                 CHANGED_APPS="${CHANGED_APPS} $app"
  #                 APP_COUNT=$((APP_COUNT + 1))
  #               fi
  #             done < "$CHANGED_APPS_LIST"
              
  #             # Trim leading space
  #             CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
  #             # Write custom output
  #             CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
  #             {
  #               echo "## ðŸš€ Production Environment"
  #               echo "Plan generated for $APP_COUNT application(s) with changes"
  #               echo ""
                
  #               if [ $APP_COUNT -gt 0 ]; then
  #                 echo "### Changed Applications:"
  #                 for app in $CHANGED_APPS; do
  #                   echo "- **$app**"  
  #                 done
  #                 echo ""
  #                 echo '```'
  #                 echo ""
  #                 echo "â–¶ï¸ To apply individual applications:"
  #                 echo ""
  #                 for app in $CHANGED_APPS; do
  #                   echo "**$app**"
  #                   echo '```'
  #                   echo "atlantis apply -p apps-production -- $app"
  #                   echo '```'
  #                   echo ""
  #                 done
  #                 echo "â© To apply **all $APP_COUNT applications**:"
  #                 echo ""
  #                 echo '```'
  #                 echo "atlantis apply -p apps-production"
  #                 echo '```'
  #               fi
                
  #               echo "ðŸ” To re-plan:"
  #               echo ""
  #               echo '```'
  #               echo "atlantis plan -p apps-production"
  #               echo ""
  #             } > "$CUSTOM_OUTPUT_FILE"
              
  #             cat "$CUSTOM_OUTPUT_FILE"
              
  #           else
  #             echo "## âœ… No Infrastructure Changes"
  #             echo "No changes detected in any application. Your infrastructure matches the configuration."
  #             echo ""
  #             echo "If you expected changes, ensure your modifications affect the Terraform configuration."
  #           fi


  #   apply:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/apply-plans.sh
  #           ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  # helia-workflow:
  #   plan:
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/process-application.sh
  #           ./scripts/process-application.sh "$ENV" "$APP_FILTER"
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           PROJECT="apps-helia"
  #           CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
  #           PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
  #           if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
  #             # Read changed apps using POSIX-compliant method
  #             CHANGED_APPS=""
  #             APP_COUNT=0
              
  #             while IFS= read -r app; do
  #               if [ -n "$app" ]; then
  #                 CHANGED_APPS="${CHANGED_APPS} $app"
  #                 APP_COUNT=$((APP_COUNT + 1))
  #               fi
  #             done < "$CHANGED_APPS_LIST"
              
  #             # Trim leading space
  #             CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
  #             # Write custom output
  #             CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
  #             {
  #               echo "## ðŸš€ Helia Environment"
  #               echo "Plan generated for $APP_COUNT application(s) with changes"
  #               echo ""
                
  #               if [ $APP_COUNT -gt 0 ]; then
  #                 echo "### Changed Applications:"
  #                 for app in $CHANGED_APPS; do
  #                   echo "- **$app**"  
  #                 done
  #                 echo ""
  #                 echo '```'
  #                 echo ""
  #                 echo "â–¶ï¸ To apply individual applications:"
  #                 echo ""
  #                 for app in $CHANGED_APPS; do
  #                   echo "**$app**"
  #                   echo '```'
  #                   echo "atlantis apply -p apps-helia -- $app"
  #                   echo '```'
  #                   echo ""
  #                 done
  #                 echo "â© To apply **all $APP_COUNT applications**:"
  #                 echo ""
  #                 echo '```'
  #                 echo "atlantis apply -p apps-helia"
  #                 echo '```'
  #               fi
                
  #               echo "ðŸ” To re-plan:"
  #               echo ""
  #               echo '```'
  #               echo "atlantis plan -p apps-helia"
  #               echo ""
  #             } > "$CUSTOM_OUTPUT_FILE"
              
  #             cat "$CUSTOM_OUTPUT_FILE"
              
  #           else
  #             echo "## âœ… No Infrastructure Changes"
  #             echo "No changes detected in any application. Your infrastructure matches the configuration."
  #             echo ""
  #             echo "If you expected changes, ensure your modifications affect the Terraform configuration."
  #           fi

  #   apply :      
  #     steps:
  #       - env:
  #           name: APP_FILTER
  #           command: echo "$COMMENT_ARGS" | tr -d '\\'
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
  #           chmod +x ./scripts/apply-plans.sh
  #           ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

