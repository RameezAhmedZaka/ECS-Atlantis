version: 3
automerge: false 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: []

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable]

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true 
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            PROJECT="apps-staging"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/process-application.sh
            ./scripts/process-application.sh "$ENV" "$APP_FILTER"
            
            # Display individual application summaries
            APP_SUMMARY_FILE="/tmp/atlantis_app_summaries_${ENV}.lst"
            if [ -f "$APP_SUMMARY_FILE" ] && [ -s "$APP_SUMMARY_FILE" ]; then
              echo ""
              echo "## ðŸ“Š Application Change Summary"
              cat "$APP_SUMMARY_FILE"
              rm -f "$APP_SUMMARY_FILE"
            fi
        - run: |
            set -euo pipefail
            ENV="staging"
            PROJECT="apps-staging"
            CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
              # Read changed apps using POSIX-compliant method
              CHANGED_APPS=""
              APP_COUNT=0
              
              while IFS= read -r app; do
                if [ -n "$app" ]; then
                  CHANGED_APPS="${CHANGED_APPS} $app"
                  APP_COUNT=$((APP_COUNT + 1))
                fi
              done < "$CHANGED_APPS_LIST"
              
              # Trim leading space
              CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
              # Calculate total resource changes
              TOTAL_ADD=0
              TOTAL_CHANGE=0
              TOTAL_DESTROY=0
              
              if [ -f "$PLANLIST" ]; then
                while IFS='|' read -r app_dir plan_file; do
                  if [ -f "$plan_file" ]; then
                    # Extract resource counts from plan files
                    PLAN_OUTPUT=$(terraform show -json "$plan_file" 2>/dev/null || echo "")
                    if [ -n "$PLAN_OUTPUT" ]; then
                      ADD=$(echo "$PLAN_OUTPUT" | grep -o '"add": [0-9]*' | head -1 | awk '{print $2}')
                      CHANGE=$(echo "$PLAN_OUTPUT" | grep -o '"change": [0-9]*' | head -1 | awk '{print $2}')
                      DESTROY=$(echo "$PLAN_OUTPUT" | grep -o '"destroy": [0-9]*' | head -1 | awk '{print $2}')
                      TOTAL_ADD=$((TOTAL_ADD + ${ADD:-0}))
                      TOTAL_CHANGE=$((TOTAL_CHANGE + ${CHANGE:-0}))
                      TOTAL_DESTROY=$((TOTAL_DESTROY + ${DESTROY:-0}))
                    fi
                  fi
                done < "$PLANLIST"
              fi
              
              # Write custom output
              CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
              {
                echo "## ðŸš€ Staging Environment - Plan Summary"
                echo ""
                echo "### ðŸ“ˆ Change Summary"
                echo "- **Projects with changes:** $APP_COUNT"
                echo "- **Resources to add:** $TOTAL_ADD"
                echo "- **Resources to change:** $TOTAL_CHANGE" 
                echo "- **Resources to destroy:** $TOTAL_DESTROY"
                echo ""
                
                if [ $APP_COUNT -gt 0 ]; then
                  echo "### ðŸ”§ Changed Applications"
                  for app in $CHANGED_APPS; do
                    echo "- **$app**"  
                  done
                  echo ""
                  echo "### ðŸŽ¯ Apply Commands"
                  echo ""
                  echo "â–¶ï¸ **Apply individual applications:**"
                  echo ""
                  for app in $CHANGED_APPS; do
                    echo '```'
                    echo "atlantis apply -p apps-staging -- $app"
                    echo '```'
                    echo ""
                  done
                  
                  echo "â© **Apply all $APP_COUNT applications:**"
                  echo '```'
                  echo "atlantis apply -p apps-staging"
                  echo '```'
                fi
                
                echo ""
                echo "### ðŸ” Re-plan Command"
                echo '```'
                echo "atlantis plan -p apps-staging"
                echo '```'
                
              } > "$CUSTOM_OUTPUT_FILE"
              
              cat "$CUSTOM_OUTPUT_FILE"
              
            else
              echo "## âœ… No Infrastructure Changes"
              echo "No changes detected in any application. Your infrastructure matches the configuration."
              echo ""
              echo "If you expected changes, ensure your modifications affect the Terraform configuration."
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            PROJECT="apps-production"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/process-application.sh
            ./scripts/process-application.sh "$ENV" "$APP_FILTER"
            
            # Display individual application summaries
            APP_SUMMARY_FILE="/tmp/atlantis_app_summaries_${ENV}.lst"
            if [ -f "$APP_SUMMARY_FILE" ] && [ -s "$APP_SUMMARY_FILE" ]; then
              echo ""
              echo "## ðŸ“Š Application Change Summary"
              cat "$APP_SUMMARY_FILE"
              rm -f "$APP_SUMMARY_FILE"
            fi
        - run: |
            set -euo pipefail
            ENV="production"
            PROJECT="apps-production"
            CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
              # Read changed apps using POSIX-compliant method
              CHANGED_APPS=""
              APP_COUNT=0
              
              while IFS= read -r app; do
                if [ -n "$app" ]; then
                  CHANGED_APPS="${CHANGED_APPS} $app"
                  APP_COUNT=$((APP_COUNT + 1))
                fi
              done < "$CHANGED_APPS_LIST"
              
              # Trim leading space
              CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
              # Calculate total resource changes
              TOTAL_ADD=0
              TOTAL_CHANGE=0
              TOTAL_DESTROY=0
              
              if [ -f "$PLANLIST" ]; then
                while IFS='|' read -r app_dir plan_file; do
                  if [ -f "$plan_file" ]; then
                    PLAN_OUTPUT=$(terraform show -json "$plan_file" 2>/dev/null || echo "")
                    if [ -n "$PLAN_OUTPUT" ]; then
                      ADD=$(echo "$PLAN_OUTPUT" | grep -o '"add": [0-9]*' | head -1 | awk '{print $2}')
                      CHANGE=$(echo "$PLAN_OUTPUT" | grep -o '"change": [0-9]*' | head -1 | awk '{print $2}')
                      DESTROY=$(echo "$PLAN_OUTPUT" | grep -o '"destroy": [0-9]*' | head -1 | awk '{print $2}')
                      TOTAL_ADD=$((TOTAL_ADD + ${ADD:-0}))
                      TOTAL_CHANGE=$((TOTAL_CHANGE + ${CHANGE:-0}))
                      TOTAL_DESTROY=$((TOTAL_DESTROY + ${DESTROY:-0}))
                    fi
                  fi
                done < "$PLANLIST"
              fi
              
              # Write custom output
              CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
              {
                echo "## ðŸš€ Production Environment - Plan Summary"
                echo ""
                echo "### ðŸ“ˆ Change Summary"
                echo "- **Projects with changes:** $APP_COUNT"
                echo "- **Resources to add:** $TOTAL_ADD"
                echo "- **Resources to change:** $TOTAL_CHANGE" 
                echo "- **Resources to destroy:** $TOTAL_DESTROY"
                echo ""
                
                if [ $APP_COUNT -gt 0 ]; then
                  echo "### ðŸ”§ Changed Applications"
                  for app in $CHANGED_APPS; do
                    echo "- **$app**"  
                  done
                  echo ""
                  echo "### ðŸŽ¯ Apply Commands"
                  echo ""
                  echo "â–¶ï¸ **Apply individual applications:**"
                  echo ""
                  for app in $CHANGED_APPS; do
                    echo '```'
                    echo "atlantis apply -p apps-production -- $app"
                    echo '```'
                    echo ""
                  done
                  
                  echo "â© **Apply all $APP_COUNT applications:**"
                  echo '```'
                  echo "atlantis apply -p apps-production"
                  echo '```'
                fi
                
                echo ""
                echo "### ðŸ” Re-plan Command"
                echo '```'
                echo "atlantis plan -p apps-production"
                echo '```'
                
              } > "$CUSTOM_OUTPUT_FILE"
              
              cat "$CUSTOM_OUTPUT_FILE"
              
            else
              echo "## âœ… No Infrastructure Changes"
              echo "No changes detected in any application. Your infrastructure matches the configuration."
              echo ""
              echo "If you expected changes, ensure your modifications affect the Terraform configuration."
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            PROJECT="apps-helia"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/process-application.sh
            ./scripts/process-application.sh "$ENV" "$APP_FILTER"
            
            # Display individual application summaries
            APP_SUMMARY_FILE="/tmp/atlantis_app_summaries_${ENV}.lst"
            if [ -f "$APP_SUMMARY_FILE" ] && [ -s "$APP_SUMMARY_FILE" ]; then
              echo ""
              echo "## ðŸ“Š Application Change Summary"
              cat "$APP_SUMMARY_FILE"
              rm -f "$APP_SUMMARY_FILE"
            fi
        - run: |
            set -euo pipefail
            ENV="helia"
            PROJECT="apps-helia"
            CHANGED_APPS_LIST="/tmp/atlantis_changed_apps_${ENV}.lst"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [ -f "$CHANGED_APPS_LIST" ] && [ -s "$CHANGED_APPS_LIST" ]; then
              # Read changed apps using POSIX-compliant method
              CHANGED_APPS=""
              APP_COUNT=0
              
              while IFS= read -r app; do
                if [ -n "$app" ]; then
                  CHANGED_APPS="${CHANGED_APPS} $app"
                  APP_COUNT=$((APP_COUNT + 1))
                fi
              done < "$CHANGED_APPS_LIST"
              
              # Trim leading space
              CHANGED_APPS=$(echo "$CHANGED_APPS" | sed 's/^ *//')
              
              # Calculate total resource changes
              TOTAL_ADD=0
              TOTAL_CHANGE=0
              TOTAL_DESTROY=0
              
              if [ -f "$PLANLIST" ]; then
                while IFS='|' read -r app_dir plan_file; do
                  if [ -f "$plan_file" ]; then
                    PLAN_OUTPUT=$(terraform show -json "$plan_file" 2>/dev/null || echo "")
                    if [ -n "$PLAN_OUTPUT" ]; then
                      ADD=$(echo "$PLAN_OUTPUT" | grep -o '"add": [0-9]*' | head -1 | awk '{print $2}')
                      CHANGE=$(echo "$PLAN_OUTPUT" | grep -o '"change": [0-9]*' | head -1 | awk '{print $2}')
                      DESTROY=$(echo "$PLAN_OUTPUT" | grep -o '"destroy": [0-9]*' | head -1 | awk '{print $2}')
                      TOTAL_ADD=$((TOTAL_ADD + ${ADD:-0}))
                      TOTAL_CHANGE=$((TOTAL_CHANGE + ${CHANGE:-0}))
                      TOTAL_DESTROY=$((TOTAL_DESTROY + ${DESTROY:-0}))
                    fi
                  fi
                done < "$PLANLIST"
              fi
              
              # Write custom output
              CUSTOM_OUTPUT_FILE="/tmp/atlantis_custom_output_${PROJECT}.txt"
              
              {
                echo "## ðŸš€ Helia Environment - Plan Summary"
                echo ""
                echo "### ðŸ“ˆ Change Summary"
                echo "- **Projects with changes:** $APP_COUNT"
                echo "- **Resources to add:** $TOTAL_ADD"
                echo "- **Resources to change:** $TOTAL_CHANGE" 
                echo "- **Resources to destroy:** $TOTAL_DESTROY"
                echo ""
                
                if [ $APP_COUNT -gt 0 ]; then
                  echo "### ðŸ”§ Changed Applications"
                  for app in $CHANGED_APPS; do
                    echo "- **$app**"  
                  done
                  echo ""
                  echo "### ðŸŽ¯ Apply Commands"
                  echo ""
                  echo "â–¶ï¸ **Apply individual applications:**"
                  echo ""
                  for app in $CHANGED_APPS; do
                    echo '```'
                    echo "atlantis apply -p apps-helia -- $app"
                    echo '```'
                    echo ""
                  done
                  
                  echo "â© **Apply all $APP_COUNT applications:**"
                  echo '```'
                  echo "atlantis apply -p apps-helia"
                  echo '```'
                fi
                
                echo ""
                echo "### ðŸ” Re-plan Command"
                echo '```'
                echo "atlantis plan -p apps-helia"
                echo '```'
                
              } > "$CUSTOM_OUTPUT_FILE"
              
              cat "$CUSTOM_OUTPUT_FILE"
              
            else
              echo "## âœ… No Infrastructure Changes"
              echo "No changes detected in any application. Your infrastructure matches the configuration."
              echo ""
              echo "If you expected changes, ensure your modifications affect the Terraform configuration."
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"