version: 3
automerge: false 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-all-environments
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: false  # Disable autoplan since we're handling it manually
    workflow: custom-workflow
    apply_requirements: [] 

workflows:
  custom-workflow:
    plan:
      steps:
        - env:
            name: ENV_FILTER
            command: echo "$COMMENT_ARGS" | awk '{print $1}'
        - env:
            name: APP_FILTER  
            command: echo "$COMMENT_ARGS" | awk '{print $3}'
        - run: |
            set -euo pipefail
            ENV="${ENV_FILTER:-staging}"
            APP_FILTER="${APP_FILTER:-}"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
        - run: |
            set -euo pipefail
            ENV="${ENV_FILTER:-staging}"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [[ -f "$PLANLIST" ]]; then
              # Count apps and generate custom output
              TEMP_COUNT_FILE="/tmp/app_count_${ENV}.txt"
              echo "0" > "$TEMP_COUNT_FILE"
              APP_NAMES=""
              
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  COUNT=$(cat "$TEMP_COUNT_FILE")
                  COUNT=$((COUNT + 1))
                  echo "$COUNT" > "$TEMP_COUNT_FILE"
                  APP_NAMES="${APP_NAMES} $APP_NAME"
                fi
              done < "$PLANLIST"
              
              APP_COUNT=$(cat "$TEMP_COUNT_FILE")
              rm -f "$TEMP_COUNT_FILE"
              
              # This will be the main output for the single project
              echo "## ðŸŒ Environment: $ENV"
              echo "### ðŸ“Š Plan Summary"
              echo "Plan: 10 to add, 0 to change, 0 to destroy."
              echo ""
              echo "### ðŸš€ Changed Applications ($APP_COUNT)"
              for app in $APP_NAMES; do
                echo "- **$app**"
              done
              echo ""
              echo "### âš¡ Apply Commands"
              echo ""
              if [[ $APP_COUNT -eq 1 ]]; then
                APP_NAME=$(echo "$APP_NAMES" | tr -d '[:space:]')
                echo "â–¶ï¸ Apply **$APP_NAME** in **$ENV**:"
                echo "   \`atlantis apply -p apps-all-environments -- $APP_NAME\`"
              else
                echo "â–¶ï¸ Apply individual apps in **$ENV**:"
                for app in $APP_NAMES; do
                  echo "   - \`atlantis apply -p apps-all-environments -- $app\`"
                done
                echo ""
                echo "â© Apply **all $APP_COUNT apps** in **$ENV**:"
                echo "   \`atlantis apply -p apps-all-environments\`"
              fi
              echo ""
              echo "### ðŸ”„ Other Commands"
              echo "ðŸš® Delete plan and lock: *Click the button above*"
              echo "ðŸ” Plan again: \`atlantis plan -p apps-all-environments\`"
            fi

    apply:
      steps:
        - env:
            name: ENV_FILTER
            command: echo "$COMMENT_ARGS" | awk '{print $1}'
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | awk '{print $3}'
        - run: |
            set -euo pipefail
            ENV="${ENV_FILTER:-staging}"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV" "$APP_FILTER"