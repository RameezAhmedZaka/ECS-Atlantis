---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
  - name: application-rdot-helia
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/helia/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot-production
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1-production
    dir: db/db1/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/production/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
workflows:
  multi_env_workflow:
    plan:
      steps:  
        - run: |
            PLANFILE="plan_${PROJECT_NAME}.tfplan"

            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
            esac

            echo "Planning for environment: $ENV"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"
            echo "Destroy flag: $DESTROY_FLAG"

            cd "$PROJECT_DIR"

            # Clean up any existing terraform files to ensure fresh state
            echo "Cleaning up previous Terraform state..."
            rm -rf .terraform
            rm -f .terraform.lock.hcl
            rm -f plan_*.tfplan

            # Initialize with upgrade to ensure latest providers and consistent lock file
            echo "Initializing Terraform with provider upgrades..."
            if [ -f "$BACKEND_CONFIG" ]; then
              timeout 300 terraform init -upgrade -input=false -reconfigure \
                -backend-config="$BACKEND_CONFIG"
            else
              timeout 300 terraform init -upgrade -input=false -reconfigure
            fi

            # Generate provider lock file for consistent environments
            echo "Generating provider lock file..."
            terraform providers lock \
              -platform=linux_amd64 \
              -platform=darwin_amd64 \
              -platform=darwin_arm64 \
              -platform=windows_amd64

            # Create plan with detailed output
            echo "Creating Terraform plan..."
            if [ -f "$VAR_FILE" ]; then
              timeout 300 terraform plan -detailed-exitcode -lock=false \
                         -var-file="$VAR_FILE" \
                         -out="$PLANFILE"
            else
              timeout 300 terraform plan -detailed-exitcode -lock=false \
                         -out="$PLANFILE"
            fi

            PLAN_EXIT_CODE=$?
            if [ $PLAN_EXIT_CODE -eq 1 ]; then
              echo "Error: Terraform plan failed"
              exit 1
            elif [ $PLAN_EXIT_CODE -eq 2 ]; then
              echo "Plan created successfully with changes"
            else
              echo "Plan created successfully with no changes"
            fi

    apply:
      steps:
        - run: |
            PLANFILE="plan_${PROJECT_NAME}.tfplan"

            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
            esac

            echo "Applying for environment: $ENV"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"

            cd "$PROJECT_DIR"

            # Re-initialize to ensure consistency between plan and apply
            echo "Re-initializing Terraform for apply..."
            if [ -f "$BACKEND_CONFIG" ]; then
              timeout 300 terraform init -input=false -reconfigure \
                -backend-config="$BACKEND_CONFIG"
            else
              timeout 300 terraform init -input=false -reconfigure
            fi

            # Verify the plan file exists and is consistent
            if [ ! -f "$PLANFILE" ]; then
              echo "Error: Plan file $PLANFILE not found. Cannot apply."
              exit 1
            fi

            echo "Verifying plan consistency..."
            terraform show -json "$PLANFILE" > /dev/null 2>&1 || {
              echo "Error: Plan file is invalid or corrupted"
              exit 1
            }

            # Apply the plan with auto-approve
            echo "Applying Terraform plan..."
            timeout 600 terraform apply -input=false -auto-approve "$PLANFILE"

            APPLY_EXIT_CODE=$?
            if [ $APPLY_EXIT_CODE -eq 0 ]; then
              echo "Apply completed successfully"
              
              # Clean up plan file after successful apply
              rm -f "$PLANFILE"
              
              # Show final state
              echo "Current state:"
              terraform show
            else
              echo "Error: Apply failed with exit code $APPLY_EXIT_CODE"
              exit $APPLY_EXIT_CODE
            fi
            rm -f "$DESTROY_PLAN"
