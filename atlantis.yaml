version: 3
automerge: true
parallel_plan: true
parallel_apply: true

projects:
  - name: apps-production
    dir: .
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: matrix-tf

workflows:
  matrix-tf:
    plan:
      steps:
        - run: |
            echo "ðŸ” Detecting changed application subdirectories..."
            git fetch origin $BASE_BRANCH --depth=1 >/dev/null 2>&1 || true

            CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD || true)
            echo "ðŸ§¾ Changed files:"
            echo "$CHANGED_FILES"

            CHANGED_DIRS=$(echo "$CHANGED_FILES" | grep '^application/' | cut -d'/' -f1-2 | sort -u || true)

            if [ -z "$CHANGED_DIRS" ]; then
              echo "âœ… No changes detected in application subdirectories."
              exit 0
            fi

            echo "ðŸ§© Changed application directories:"
            echo "$CHANGED_DIRS"

            for dir in $CHANGED_DIRS; do
              echo "ðŸš€ Running Terraform init for $dir"
              cd "$dir"
              terraform init -input=false -backend-config="./env/production/prod.conf"

              echo "ðŸ“¦ Running Terraform plan for $dir"
              terraform plan -input=false -no-color -var-file="./config/production.tfvars" -out=tfplan

              cd - > /dev/null
            done

    apply:
      steps:
        - run: |
            echo "ðŸ” Detecting changed application subdirectories..."
            git fetch origin $BASE_BRANCH --depth=1 >/dev/null 2>&1 || true

            CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD || true)
            echo "ðŸ§¾ Changed files:"
            echo "$CHANGED_FILES"

            CHANGED_DIRS=$(echo "$CHANGED_FILES" | grep '^application/' | cut -d'/' -f1-2 | sort -u || true)

            if [ -z "$CHANGED_DIRS" ]; then
              echo "âœ… No changes detected to apply."
              exit 0
            fi

            echo "ðŸ§© Changed application directories:"
            echo "$CHANGED_DIRS"

            for dir in $CHANGED_DIRS; do
              echo "ðŸš€ Applying Terraform for $dir"
              cd "$dir"
              terraform apply -input=false -auto-approve -var-file="./config/production.tfvars" tfplan || true
              cd - > /dev/null
            done
