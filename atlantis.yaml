version: 3
automerge: false
parallel_plan: true
parallel_apply: true

projects:
  - name: dynamic-discovery
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: false  # Disable autoplan, we'll handle it manually
    workflow: dynamic-workflow

workflows:
  dynamic-workflow:
    plan:
      steps:
        - run: 
            command: ./discover-and-plan.sh
    apply:
      steps:
        - run:
            command: ./discover-and-apply.sh

  # production-workflow:
  #   plan:
  #     steps:
  #       - run: |
  #           set -euo pipefix
  #           ENV="production"
  #           echo "=== Processing PRODUCTION environment ==="
  #           chmod +x ./process-application.sh
  #           ./process-application.sh "$ENV" "$ATLANTIS_PROJECT_DIR"
  #   apply:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="production"
  #           echo "=== Applying PRODUCTION environment ==="
  #           chmod +x ./apply-plans.sh
  #           ./apply-plans.sh "$ENV"

  # helia-workflow:
  #   plan:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "=== Processing HELIA environment ==="
  #           chmod +x ./process-application.sh
  #           ./process-application.sh "$ENV" "$ATLANTIS_PROJECT_DIR"
  #   apply:
  #     steps:
  #       - run: |
  #           set -euo pipefail
  #           ENV="helia"
  #           echo "=== Applying HELIA environment ==="
  #           chmod +x ./apply-plans.sh
  #           ./apply-plans.sh "$ENV"
