version: 3
automerge: false 
parallel_plan: false  
parallel_apply: false  

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: [] 

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true  
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable] 

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true 
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []     

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "DEBUG: Raw COMMENT_ARGS='$COMMENT_ARGS'"
            echo "DEBUG: Cleaned APP_FILTER='$APP_FILTER'"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/process-application.sh
            ./scripts/process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output in Atlantis format
        - run: |
            set -euo pipefail
            ENV="staging"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [[ -f "$PLANLIST" ]]; then
              # Count apps
              TEMP_COUNT_FILE="/tmp/app_count_${ENV}.txt"
              echo "0" > "$TEMP_COUNT_FILE"
              APP_NAMES=""
              
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  COUNT=$(cat "$TEMP_COUNT_FILE")
                  COUNT=$((COUNT + 1))
                  echo "$COUNT" > "$TEMP_COUNT_FILE"
                  APP_NAMES="${APP_NAMES} $APP_NAME"
                fi
              done < "$PLANLIST"
              
              APP_COUNT=$(cat "$TEMP_COUNT_FILE")
              rm -f "$TEMP_COUNT_FILE"
              
              # Generate the main output (this will be captured by Atlantis)
              echo "### Changed Applications ($APP_COUNT):"
              for app in $APP_NAMES; do
                echo "- $app"
              done
              echo ""
              echo "---"
              echo ""
              echo "### Apply Commands:"
              echo ""
              #
              # NEW APPROACH:
              # For each application we print two separate, copyable boxes:
              # 1) a plain code block with the raw atlantis command (easy to copy/run)
              # 2) a code block that contains the exact comment to post to Atlantis (including surrounding backticks),
              #    so the maintainer can copy the full comment text and paste it directly into PR comments.
              #
              if [[ $APP_COUNT -eq 1 ]]; then
                APP_NAME=$(echo "$APP_NAMES" | tr -d '[:space:]')
                echo "â–¶ï¸ To apply **$APP_NAME**, you can:"
                echo ""
                # plain command block (copy & run)
                echo '```bash'
                echo "atlantis apply -p apps-staging -- $APP_NAME"
                echo '```'
                echo ""
                # exact PR comment block (copy & paste directly into PR)
                echo "Or copy this exact comment (with backticks) into the PR to trigger Atlantis:"
                echo '```'
                echo "\`atlantis apply -p apps-staging -- $APP_NAME\`"
                echo '```'
              else
                echo "â–¶ï¸ To apply individual applications, copy one of the commands below:"
                for app in $APP_NAMES; do
                  echo ""
                  # plain command block
                  echo '```bash'
                  echo "atlantis apply -p apps-staging -- $app"
                  echo '```'
                  echo ""
                  # exact PR comment block (shows the comment you should paste into PR)
                  echo "Comment to paste into the PR (includes backticks):"
                  echo '```'
                  echo "\`atlantis apply -p apps-staging -- $app\`"
                  echo '```'
                done
                echo ""
                echo "â© To apply ALL changed applications at once, use:"
                echo ""
                echo '```bash'
                echo "atlantis apply -p apps-staging"
                echo '```'
                echo ""
                echo "Or copy the comment below to the PR to apply them all:"
                echo '```'
                echo "\`atlantis apply -p apps-staging\`"
                echo '```'
              fi
              echo ""
              echo "ðŸš® To delete this plan and lock, click here"
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-staging\`"
              echo '```'
            else
              # Fallback to default output if no planlist
              echo "â–¶ï¸ To apply this plan, comment:"
              echo ""
              echo '```bash'
              echo "atlantis apply -p apps-staging"
              echo '```'
              echo ""
              echo "Or copy this exact PR comment:"
              echo '```'
              echo "\`atlantis apply -p apps-staging\`"
              echo '```'
              echo "ðŸš® To delete this plan and lock, click here"
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-staging\`"
              echo '```'
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output in Atlantis format
        - run: |
            set -euo pipefail
            ENV="production"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [[ -f "$PLANLIST" ]]; then
              TEMP_COUNT_FILE="/tmp/app_count_${ENV}.txt"
              echo "0" > "$TEMP_COUNT_FILE"
              APP_NAMES=""
              
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  COUNT=$(cat "$TEMP_COUNT_FILE")
                  COUNT=$((COUNT + 1))
                  echo "$COUNT" > "$TEMP_COUNT_FILE"
                  APP_NAMES="${APP_NAMES} $APP_NAME"
                fi
              done < "$PLANLIST"
              
              APP_COUNT=$(cat "$TEMP_COUNT_FILE")
              rm -f "$TEMP_COUNT_FILE"
              
              echo "### Changed Applications ($APP_COUNT):"
              for app in $APP_NAMES; do
                echo "- $app"
              done
              echo ""
              echo "---"
              echo ""
              echo "### Apply Commands:"
              echo ""
              # NEW APPROACH applied here as well
              if [[ $APP_COUNT -eq 1 ]]; then
                APP_NAME=$(echo "$APP_NAMES" | tr -d '[:space:]')
                echo "â–¶ï¸ To apply **$APP_NAME**, you can:"
                echo ""
                echo '```bash'
                echo "atlantis apply -p apps-production -- $APP_NAME"
                echo '```'
                echo ""
                echo "Or copy this exact comment into the PR:"
                echo '```'
                echo "\`atlantis apply -p apps-production -- $APP_NAME\`"
                echo '```'
              else
                echo "â–¶ï¸ To apply individual applications, copy one of the commands below:"
                for app in $APP_NAMES; do
                  echo ""
                  echo '```bash'
                  echo "atlantis apply -p apps-production -- $app"
                  echo '```'
                  echo ""
                  echo "Comment to paste into the PR:"
                  echo '```'
                  echo "\`atlantis apply -p apps-production -- $app\`"
                  echo '```'
                done
                echo ""
                echo "â© To apply ALL changed applications at once, use:"
                echo ""
                echo '```bash'
                echo "atlantis apply -p apps-production"
                echo '```'
                echo ""
                echo "Or copy the comment below to the PR to apply them all:"
                echo '```'
                echo "\`atlantis apply -p apps-production\`"
                echo '```'
              fi
              echo ""
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-production\`"
              echo '```'
            else
              echo "â–¶ï¸ To apply this plan, comment:"
              echo ""
              echo '```bash'
              echo "atlantis apply -p apps-production"
              echo '```'
              echo ""
              echo "Or copy this exact PR comment:"
              echo '```'
              echo "\`atlantis apply -p apps-production\`"
              echo '```'
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-production\`"
              echo '```'
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="production"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "Running Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/process-application.sh
            ./scripts/process-application.sh "$ENV" "$APP_FILTER"
        # Generate custom output in Atlantis format
        - run: |
            set -euo pipefail
            ENV="helia"
            PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
            
            if [[ -f "$PLANLIST" ]]; then
              TEMP_COUNT_FILE="/tmp/app_count_${ENV}.txt"
              echo "0" > "$TEMP_COUNT_FILE"
              APP_NAMES=""
              
              while IFS='|' read -r d PLAN; do
                APP_NAME=$(basename "$d" | tr -d '[:space:]')
                if [[ -n "$APP_NAME" ]]; then
                  COUNT=$(cat "$TEMP_COUNT_FILE")
                  COUNT=$((COUNT + 1))
                  echo "$COUNT" > "$TEMP_COUNT_FILE"
                  APP_NAMES="${APP_NAMES} $APP_NAME"
                fi
              done < "$PLANLIST"
              
              APP_COUNT=$(cat "$TEMP_COUNT_FILE")
              rm -f "$TEMP_COUNT_FILE"
              
              echo "### Changed Applications ($APP_COUNT):"
              for app in $APP_NAMES; do
                echo "- $app"
              done
              echo ""
              echo "---"
              echo ""
              echo "### Apply Commands:"
              echo ""
              # NEW APPROACH applied here as well
              if [[ $APP_COUNT -eq 1 ]]; then
                APP_NAME=$(echo "$APP_NAMES" | tr -d '[:space:]')
                echo "â–¶ï¸ To apply **$APP_NAME**, you can:"
                echo ""
                echo '```bash'
                echo "atlantis apply -p apps-helia -- $APP_NAME"
                echo '```'
                echo ""
                echo "Or copy this exact comment into the PR:"
                echo '```'
                echo "\`atlantis apply -p apps-helia -- $APP_NAME\`"
                echo '```'
              else
                echo "â–¶ï¸ To apply individual applications, copy one of the commands below:"
                for app in $APP_NAMES; do
                  echo ""
                  echo '```bash'
                  echo "atlantis apply -p apps-helia -- $app"
                  echo '```'
                  echo ""
                  echo "Comment to paste into the PR:"
                  echo '```'
                  echo "\`atlantis apply -p apps-helia -- $app\`"
                  echo '```'
                done
                echo ""
                echo "â© To apply ALL changed applications at once, use:"
                echo ""
                echo '```bash'
                echo "atlantis apply -p apps-helia"
                echo '```'
                echo ""
                echo "Or copy the comment below to the PR to apply them all:"
                echo '```'
                echo "\`atlantis apply -p apps-helia\`"
                echo '```'
              fi
              echo ""
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-helia\`"
              echo '```'
            else
              echo "â–¶ï¸ To apply this plan, comment:"
              echo ""
              echo '```bash'
              echo "atlantis apply -p apps-helia"
              echo '```'
              echo ""
              echo "Or copy this exact PR comment:"
              echo '```'
              echo "\`atlantis apply -p apps-helia\`"
              echo '```'
              echo "ðŸ” To plan this project again, comment:"
              echo ""
              echo '```'
              echo "\`atlantis plan -p apps-helia\`"
              echo '```'
            fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run: |
            set -euo pipefail
            ENV="helia"
            echo "Applying Atlantis plan for ENV=$ENV with APP_FILTER=$APP_FILTER"
            chmod +x ./scripts/apply-plans.sh
            ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"