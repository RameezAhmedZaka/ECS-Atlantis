version: 3
automerge: false
parallel_plan: false
parallel_apply: false

projects:
  - name: apps-staging
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: []

  - name: apps-production
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [approved, mergeable]

  - name: apps-helia
    dir: .
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "application/**"
    workflow: helia-workflow
    apply_requirements: []

workflows:
  staging-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="staging"
              echo "ðŸ”µ Running Staging plan with APP_FILTER='$APP_FILTER'"

              # create a unique plan list file to avoid collisions with other workflows
              PLANLIST="$(mktemp /tmp/atlantis_planfiles_${ENV}.XXXXXX)"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"

              chmod +x ./scripts/process-application.sh

              # Capture the script output into the unique planlist file.
              # If your process-application.sh already writes to a file, update it to write to stdout
              # or accept an output-file argument so this redirection captures the correct content.
              ./scripts/process-application.sh "$ENV" "$APP_FILTER" > "$PLANLIST"

              # persist the path so subsequent workflow steps can read it
              echo "$PLANLIST" > "$PLANLIST_PATH_FILE"
        - run:
            command: |
              set -euo pipefail
              ENV="staging"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              PLANLIST=""

              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              if [[ -n "$PLANLIST" && -f "$PLANLIST" ]]; then
                echo ""
                echo "---"
                echo "## ðŸš€ Staging Apply Commands"
                echo ""
                while IFS='|' read -r d PLAN; do
                  APP_NAME=$(basename "$d" | tr -d '[:space:]')
                  if [[ -n "$APP_NAME" ]]; then
                    echo "**Apply $APP_NAME:**"
                    echo '```shell'
                    echo "atlantis apply -p apps-staging -- $APP_NAME"
                    echo '```'
                    echo ""
                  fi
                done < "$PLANLIST"
                echo "**Apply all staging applications:**"
                echo '```shell'
                echo "atlantis apply -p apps-staging"
                echo '```'
              fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="staging"
              echo "ðŸ”µ Applying Staging changes with APP_FILTER='$APP_FILTER'"

              # restore PLANLIST for apply step if present
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                export PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  production-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="production"
              echo "ðŸ”´ Running Production plan with APP_FILTER='$APP_FILTER'"

              PLANLIST="$(mktemp /tmp/atlantis_planfiles_${ENV}.XXXXXX)"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"

              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER" > "$PLANLIST"
              echo "$PLANLIST" > "$PLANLIST_PATH_FILE"
        - run:
            command: |
              set -euo pipefail
              ENV="production"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              PLANLIST=""

              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              if [[ -n "$PLANLIST" && -f "$PLANLIST" ]]; then
                echo ""
                echo "---"
                echo "## ðŸš€ Production Apply Commands"
                echo ""
                while IFS='|' read -r d PLAN; do
                  APP_NAME=$(basename "$d" | tr -d '[:space:]')
                  if [[ -n "$APP_NAME" ]]; then
                    echo "**Apply $APP_NAME:**"
                    echo '```shell'
                    echo "atlantis apply -p apps-production -- $APP_NAME"
                    echo '```'
                    echo ""
                  fi
                done < "$PLANLIST"
                echo "**Apply all production applications:**"
                echo '```shell'
                echo "atlantis apply -p apps-production"
                echo '```'
              fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="production"
              echo "ðŸ”´ Applying Production changes with APP_FILTER='$APP_FILTER'"

              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                export PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"

  helia-workflow:
    plan:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="helia"
              echo "ðŸŸ£ Running Helia plan with APP_FILTER='$APP_FILTER'"

              PLANLIST="$(mktemp /tmp/atlantis_planfiles_${ENV}.XXXXXX)"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"

              chmod +x ./scripts/process-application.sh
              ./scripts/process-application.sh "$ENV" "$APP_FILTER" > "$PLANLIST"
              echo "$PLANLIST" > "$PLANLIST_PATH_FILE"
        - run:
            command: |
              set -euo pipefail
              ENV="helia"
              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              PLANLIST=""

              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              if [[ -n "$PLANLIST" && -f "$PLANLIST" ]]; then
                echo ""
                echo "---"
                echo "## ðŸš€ Helia Apply Commands"
                echo ""
                while IFS='|' read -r d PLAN; do
                  APP_NAME=$(basename "$d" | tr -d '[:space:]')
                  if [[ -n "$APP_NAME" ]]; then
                    echo "**Apply $APP_NAME:**"
                    echo '```shell'
                    echo "atlantis apply -p apps-helia -- $APP_NAME"
                    echo '```'
                    echo ""
                  fi
                done < "$PLANLIST"
                echo "**Apply all helia applications:**"
                echo '```shell'
                echo "atlantis apply -p apps-helia"
                echo '```'
              fi

    apply:
      steps:
        - env:
            name: APP_FILTER
            command: echo "$COMMENT_ARGS" | tr -d '\\'
        - run:
            command: |
              set -euo pipefail
              ENV="helia"
              echo "ðŸŸ£ Applying Helia changes with APP_FILTER='$APP_FILTER'"

              PLANLIST_PATH_FILE="/tmp/atlantis_planfile_path_${ENV}"
              if [[ -f "$PLANLIST_PATH_FILE" ]]; then
                export PLANLIST="$(cat "$PLANLIST_PATH_FILE")"
              fi

              chmod +x ./scripts/apply-plans.sh
              ./scripts/apply-plans.sh "$ENV" "$APP_FILTER"