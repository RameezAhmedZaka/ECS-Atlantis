---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
  - name: application-app11
    dir: application/app11/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/*/*"
    terraform_version: v1.6.6
    apply_requirements:
      - approved
      - mergeable
  - name: application-rdot
    dir: application/rdot/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/*/*"
    terraform_version: v1.6.6
    apply_requirements:
      - approved
      - mergeable
  - name: db-db1
    dir: db/db1/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/*/*"
    terraform_version: v1.6.6
    apply_requirements:
      - approved
      - mergeable
  - name: db-db71
    dir: db/db71/
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "config/*.tfvars"
        - "env/*/*"
    terraform_version: v1.6.6
    apply_requirements:
      - approved
      - mergeable
workflows:
  default:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            echo "Working directory: $PWD"
            
            # Detect environment based on changed files
            ENVIRONMENT="production"  # default
            BACKEND_CONFIG="env/production/prod.conf"
            VAR_FILE="config/production.tfvars"
            
            # Check which environment files were modified
            if [[ -n "$(git diff --name-only HEAD~1 | grep -E 'env/staging/|config/stage\.tfvars')" ]]; then
              ENVIRONMENT="staging"
              BACKEND_CONFIG="env/staging/stage.conf"
              VAR_FILE="config/stage.tfvars"
            elif [[ -n "$(git diff --name-only HEAD~1 | grep -E 'env/helia/|config/helia\.tfvars')" ]]; then
              ENVIRONMENT="helia"
              BACKEND_CONFIG="env/helia/helia.conf"
              VAR_FILE="config/helia.tfvars"
            elif [[ -n "$(git diff --name-only HEAD~1 | grep -E 'env/production/|config/production\.tfvars')" ]]; then
              ENVIRONMENT="production"
              BACKEND_CONFIG="env/production/prod.conf"
              VAR_FILE="config/production.tfvars"
            fi
            
            echo "Detected environment: $ENVIRONMENT"
            
            # Store environment in file for apply phase
            echo "$ENVIRONMENT" > /tmp/current_environment.txt
            echo "$BACKEND_CONFIG" > /tmp/backend_config.txt
            echo "$VAR_FILE" > /tmp/var_file.txt
            
            # Initialize and plan
            rm -rf .terraform .terraform.lock.hcl
            terraform init -backend-config=$BACKEND_CONFIG -reconfigure -lock=false -input=false
            terraform plan -var-file=$VAR_FILE -lock-timeout=10m -out=$PLANFILE

    apply:
      steps:
        - run: |
            ENVIRONMENT=$(cat /tmp/current_environment.txt)
            BACKEND_CONFIG=$(cat /tmp/backend_config.txt)
            VAR_FILE=$(cat /tmp/var_file.txt)
            
            echo "Applying changes for environment: $ENVIRONMENT"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"
            
            # Re-initialize to ensure correct backend
            terraform init -backend-config=$BACKEND_CONFIG -reconfigure -lock=false -input=false
            terraform apply -auto-approve $PLANFILE
