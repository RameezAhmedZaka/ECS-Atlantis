version: 3
automerge: false  # Disable until working
parallel_plan: false  # Disable until working
parallel_apply: false  # Disable until working 
apply_requirements: [] 

projects:
  - name: apps-staging
    dir: .
    workspace: staging
    terraform_version: v1.6.6
    autoplan:
      enabled: true  # DISABLE FOR TESTING
      when_modified:
        - "application/**"
    workflow: staging-workflow
    apply_requirements: [] 

  - name: apps-production
    dir: .
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: true  # DISABLE FOR TESTING
      when_modified:
        - "application/**"
    workflow: production-workflow
    apply_requirements: [] 

workflows:
  staging-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Processing STAGING environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="staging"
            echo "=== Applying STAGING environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"

  production-workflow:
    plan:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Processing PRODUCTION environment ==="
            chmod +x ./process-application.sh
            ./process-application.sh "$ENV"
    apply:
      steps:
        - run: |
            set -euo pipefail
            ENV="production"
            echo "=== Applying PRODUCTION environment ==="
            chmod +x ./apply-plans.sh
            ./apply-plans.sh "$ENV"




# version: 3
# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: ./terraform_env.sh
#             output: show
#         - init: {}
#         - plan: {}
#     apply:
#       steps:
#         - apply: {}

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: ./terraform_env.sh
#             output: show
#         - init: {}
#         - plan: {}
#     apply:
#       steps:
#         - apply: {}






  # - name: application
  #   dir: application
  #   workspace: stage
  #   workflow: dev-workflow
  #   apply_requirements: []
  #   autoplan:
  #     when_modified: ["*.tf", "config/*.tfvars", "modules/**/*.tf", "**/*.tf"]
  #     enabled: true

  # - name: application-prod
  #   dir: application
  #   workspace: production
  #   workflow: prod-workflow
  #   apply_requirements: []
  #   autoplan:
  #     when_modified: ["*.tf", "config/*.tfvars", "modules/**/*.tf", "**/*.tf"]
  #     enabled: true

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Processing app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform init -backend-config="env/staging/stage.conf"
#                 terraform plan -var-file="config/stage.tfvars" -out="$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done
#     apply:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Applying app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform apply -var-file="config/stage.tfvars" "$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done

#   prod-workflow:
#     plan:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Processing app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform init -backend-config="env/production/prod.conf"
#                 terraform plan -var-file="config/production.tfvars" -out="$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done
#     apply:
#       steps:
#         - run: |
#             for dir in $(ls application); do
#               if [ -f "application/$dir/backend.tf" ]; then
#                 echo "Applying app: $dir"
#                 cd "application/$dir" || exit 1
#                 terraform apply -var-file="config/production.tfvars" "$PWD/$ATLANTIS_REPO_NAME-$ATLANTIS_PULL_NUM.tfplan"
#                 cd - >/dev/null
#               fi
#             done

####

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d init -backend-config="$d/env/staging/stage.conf"
#                 terraform -chdir=$d plan -var-file="$d/config/stage.tfvars"
#               done
#     apply:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d apply -var-file="$d/config/stage.tfvars" -auto-approve
#               done

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d init -backend-config="$d/env/production/prod.conf"
#                 terraform -chdir=$d plan -var-file="$d/config/production.tfvars"
#               done
#     apply:
#       steps:
#         - run:
#             command: |
#               for d in $(find . -mindepth 1 -maxdepth 1 -type d); do
#                 terraform -chdir=$d apply -var-file="$d/config/production.tfvars" -auto-approve
#               done

# workflows:
#   dev-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls
#         - init:
#             extra_args: ["-backend-config=env/staging/stage.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/stage.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/stage.tfvars"]

#   prod-workflow:
#     plan:
#       steps:
#         - run:
#             command: ls      
#         - init:
#             extra_args: ["-backend-config=env/production/prod.conf"]
#         - plan: 
#             extra_args: ["-var-file=./config/production.tfvars"]
#     apply:
#       steps:
#         - apply:
#             extra_args: ["-var-file=./config/production.tfvars"]


  # - name: databases
  #   dir: databases/*
  #   autoplan:
  #     when_modified: ["databases/**/*.tf", "databases/**/config/*.tfvars", "databases/**/env/**/*.conf"]
  #     enabled: true


# version: 3
# automerge: true
# parallel_plan: true
# parallel_apply: true

# projects:
#   - name: apps-staging
#     dir: .
#     workspace: staging
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true
#       when_modified:
#         - "application/**"
#     workflow: matrix-tf

#   - name: apps-production
#     dir: .
#     workspace: production
#     terraform_version: v1.6.6
#     autoplan:
#       enabled: true
#       when_modified:
#         - "application/**"
#     workflow: matrix-tf

# workflows:
#   matrix-tf:
#     plan:
#       steps:
#         - run:
#             shell: bash
#             command: |
#               set -euo pipefail
#               ENV="${ATLANTIS_WORKSPACE}"

#               # Collect changed application directories
#               mapfile -t dirs < <(
#                 printf "%s\n" $CHANGED_FILES \
#                   | grep -E "^application/[^/]+/" \
#                   | awk -F/ '{print $1"/"$2}' \
#                   | sort -u
#               )

#               if [[ ${#dirs[@]} -eq 0 ]]; then
#                 echo "No changed application directories."
#                 exit 0
#               fi

#               PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"
#               : > "$PLANLIST"

#               for d in "${dirs[@]}"; do
#                 if [[ -f "$d/main.tf" ]]; then
#                   echo "=== Initializing $d ($ENV) ==="

#                   # Initialize Terraform with backend config
#                   terraform -chdir="$d" init -upgrade -backend-config="env/${ENV}/${ENV}.conf"

#                   # Select or create workspace
#                   terraform -chdir="$d" workspace select "$ENV" \
#                     || terraform -chdir="$d" workspace new "$ENV"

#                   TFVARS="$d/config/${ENV}.tfvars"
#                   PLAN="/tmp/$(echo "$d" | tr "/" "_")_${ENV}.tfplan"

#                   echo "=== Planning $d ($ENV) ==="
#                   if [[ -f "$TFVARS" ]]; then
#                     terraform -chdir="$d" plan -input=false -lock-timeout=20m -var-file="$TFVARS" -out="$PLAN"
#                   else
#                     echo "No tfvars for $d â€” proceeding without -var-file"
#                     terraform -chdir="$d" plan -input=false -lock-timeout=20m -out="$PLAN"
#                   fi

#                   echo "$PLAN" >> "$PLANLIST"
#                 else
#                   echo "Skipping it $d (no main.tf)"
#                 fi
#               done

#               echo "Plan files recorded in $PLANLIST"

#     apply:
#       steps:
#         - run:
#             shell: bash
#             command: |
#               set -euo pipefail
#               ENV="${ATLANTIS_WORKSPACE}"
#               PLANLIST="/tmp/atlantis_planfiles_${ENV}.lst"

#               if [[ ! -s "$PLANLIST" ]]; then
#                 echo "No plan files to apply."
#                 exit 0
#               fi

#               while IFS= read -r PLAN; do
#                 echo "=== Applying $PLAN ==="
#                 terraform apply -input=false "$PLAN"
#               done < "$PLANLIST"
