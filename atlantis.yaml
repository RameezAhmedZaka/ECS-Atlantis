version: 3
automerge: true
parallel_plan: true
parallel_apply: true

projects:
# Dynamically generated projects
# Each app will have two workspaces: production and staging
# backend-config and var-file are set per workspace

{{- $apps := (exec "bash" "-c" "grep -Pl 'backend[\\s]+\"s3\"' applications/*/*.tf | rev | cut -d'/' -f2- | rev | sort | uniq") }}
{{- range $apps.Split "\n" }}
  - name: {{ . }}-production
    dir: {{ . }}
    workspace: production
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "**/*.tf"
        - "config/production.tfvars"
    workflow: default
    apply_requirements: []
    workspace_hooks:
      init:
        steps:
          - run: terraform init -backend-config={{ . }}/env/production/prod.conf
      plan:
        steps:
          - run: terraform plan -var-file={{ . }}/config/production.tfvars
      apply:
        steps:
          - run: terraform apply -var-file={{ . }}/config/production.tfvars

  - name: {{ . }}-staging
    dir: {{ . }}
    workspace: staging
    terraform_version: v1.6.6
    autoplan:
      enabled: true
      when_modified:
        - "**/*.tf"
        - "config/stage.tfvars"
    workflow: default
    apply_requirements: []
    workspace_hooks:
      init:
        steps:
          - run: terraform init -backend-config={{ . }}/env/staging/stage.conf
      plan:
        steps:
          - run: terraform plan -var-file={{ . }}/config/stage.tfvars
      apply:
        steps:
          - run: terraform apply -var-file={{ . }}/config/stage.tfvars

{{- end }}
