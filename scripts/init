#!/bin/bash
set -euo pipefail

echo "Generating dynamic atlantis.yaml for $(basename "$(pwd)")"

# Start atlantis.yaml
cat > atlantis.yaml <<-EOF
---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
EOF

# Check if a directory is a Terraform project
is_terraform_project() {
    local dir="$1"
    [ -f "$dir/main.tf" ] && [ -f "$dir/variables.tf" ] && [ -f "$dir/providers.tf" ]
}

# Loop through top-level dirs (apps)
for base_dir in */; do
    [ -d "$base_dir" ] || continue
    for app_dir in "$base_dir"*/; do
        [ -d "$app_dir" ] || continue
        if is_terraform_project "$app_dir"; then
            app_name="$(basename "$app_dir")"

            # Add project entries for each environment
            for env in helia staging production; do
                env_path="${app_dir}env/${env}"
                [ -d "$env_path" ] || continue

                cat >> atlantis.yaml << PROJECT_EOF
  - name: ${base_dir%/}-${app_name}-${env}
    dir: $env_path
    autoplan:
      enabled: true
      when_modified:
        - "../../*.tf"
        - "../../config/*.tfvars"
        - "../../env/*/*"
    terraform_version: v1.6.6
    workflow: ${env}_workflow
    apply_requirements:
      - approved
      - mergeable
PROJECT_EOF
            done
        fi
    done
done

# Create separate workflows with -reconfigure flag
cat >> atlantis.yaml << 'EOF'
workflows:
  production_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform
        - init:
            extra_args: [-backend-config=env/production/prod.conf, -reconfigure, -input=false]
            dir: "$PROJECT_DIR"
        - run: echo "Init completed successfully"
        - plan:
            extra_args: [-var-file=config/production.tfvars, -lock-timeout=10m, -out=$PLANFILE]
            dir: "$PROJECT_DIR"
        - run: echo "Plan completed successfully"
    apply:
      steps:
        - apply:
            extra_args: [-lock-timeout=10m]
            dir: "$PROJECT_DIR"

  staging_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform
        - init:
            extra_args: [-backend-config=env/staging/stage.conf, -reconfigure, -input=false]
            dir: "$PROJECT_DIR"
        - run: echo "Init completed successfully"    
        - plan:
            extra_args: [-var-file=config/stage.tfvars, -lock-timeout=10m, -out=$PLANFILE]
            dir: "$PROJECT_DIR"
    apply:
      steps:
        - apply:
            extra_args: [-lock-timeout=10m]
            dir: "$PROJECT_DIR"

  helia_workflow:
    plan:
      steps:
        - run: |
            echo "Project: $PROJECT_NAME"
            cd "$(dirname "$PROJECT_DIR")/../.."
            rm -rf .terraform
        - init:
            extra_args: [-backend-config=env/helia/helia.conf, -reconfigure, -input=false]
            dir: "$PROJECT_DIR"
        - run: echo "Init completed successfully"      
        - plan:
            extra_args: [-var-file=config/helia.tfvars, -lock-timeout=10m, -out=$PLANFILE]
            dir: "$PROJECT_DIR"
    apply:
      steps:
        - apply:
            extra_args: [-lock-timeout=10m]
            dir: "$PROJECT_DIR"
EOF
