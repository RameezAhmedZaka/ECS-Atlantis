#!/bin/bash
set -euo pipefail

echo "Generating dynamic atlantis.yaml for $(basename "$(pwd)")"

# Start atlantis.yaml
cat > atlantis.yaml <<-EOF
---
version: 3
automerge: true
parallel_plan: false
parallel_apply: false
projects:
EOF

# Check if a directory is a Terraform project
is_terraform_project() {
    local dir="$1"
    [ -f "$dir/main.tf" ] && [ -f "$dir/variables.tf" ] && [ -f "$dir/providers.tf" ]
}

# Loop through app directories (like app1/, app2/, etc.)
for app_dir in */; do
    [ -d "$app_dir" ] || continue
    if is_terraform_project "$app_dir"; then
        app_name="$(basename "$app_dir")"

        # Add project entries for each environment
        for env in helia staging production; do
            env_path="${app_dir}env/${env}"
            [ -d "$env_path" ] || continue

            cat >> atlantis.yaml << PROJECT_EOF
  - name: ${app_name}-${env}
    dir: .
    autoplan:
      enabled: true
      when_modified:
        - "${app_dir}*.tf"
        - "${app_dir}config/*.tfvars"
        - "${app_dir}env/${env}/*"
    terraform_version: v1.6.6
    workflow: multi_env_workflow
    apply_requirements:
      - approved
      - mergeable
PROJECT_EOF
        done
    fi
done

# Workflows section with proper directory handling
cat >> atlantis.yaml << 'EOF'
workflows:
  multi_env_workflow:
    plan:
      steps:
        - run: |
            PLANFILE="plan_${PROJECT_NAME}.tfplan"
            APP_NAME=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1}')
            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="default"
                BACKEND_CONFIG=""
                VAR_FILE=""
                ;;
            esac

            echo "Planning for environment: $ENV"
            echo "Using backend config: $BACKEND_CONFIG"
            echo "Using var file: $VAR_FILE"

            # Move two directories up to main Terraform project
             cd "$APP_NAME"

            rm -rf .terraform

            if [ -f "$BACKEND_CONFIG" ]; then
              timeout 300 terraform init \
                -backend-config="$BACKEND_CONFIG" \
                -input=false -reconfigure > /dev/null 2>&1
            else
              terraform init -input=false -reconfigure
            fi

            if [ -f "$VAR_FILE" ]; then
              timeout 300 terraform plan -lock-timeout=5m  \
                         -var-file="$VAR_FILE" \
                         -out="$PLANFILE"
            else
              terraform plan $DESTROY_FLAG -out="$PLANFILE"
            fi

    apply:
      steps:
        - run: |
            PLANFILE="plan_${PROJECT_NAME}.tfplan"
            APP_NAME=$(echo "$PROJECT_NAME" | awk -F'-' '{print $1}')
            case "$PROJECT_NAME" in
              *-production)
                ENV="production"
                BACKEND_CONFIG="env/production/prod.conf"
                VAR_FILE="config/production.tfvars"
                ;;
              *-staging)
                ENV="staging"
                BACKEND_CONFIG="env/staging/stage.conf"
                VAR_FILE="config/stage.tfvars"
                ;;
              *-helia)
                ENV="helia"
                BACKEND_CONFIG="env/helia/helia.conf"
                VAR_FILE="config/helia.tfvars"
                ;;
              *)
                ENV="default"
                BACKEND_CONFIG=""
                VAR_FILE=""
                ;;
            esac
             
            echo "Applying for environment: $ENV"

            # Move two directories up to main Terraform project
            cd "$APP_NAME"
            # if [ -f "$BACKEND_CONFIG" ]; then
            #   timeout 300 terraform init \
            #     -backend-config="$BACKEND_CONFIG" \
            #     -input=false -reconfigure > /dev/null 2>&1
            # else
            #   terraform init -input=false -reconfigure > /dev/null 2>&1
            # fi

            if [ -f "$PLANFILE" ]; then
              timeout 600 terraform apply -input=false -lock-timeout=5m  -auto-approve "$PLANFILE" || {
                echo "Apply failed for $PLANFILE"
              }
            else
              {
                echo "Apply failed for $PROJECT_DIR"
              }
            fi
EOF
