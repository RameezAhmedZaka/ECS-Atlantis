repos:
  - id: /.*/
    allow_custom_workflows: true
    allowed_overrides:
      - apply_requirements
      - workflow
      - plan_requirements
    apply_requirements: []
    workflow: multi_env_workflow
    pre_workflow_hooks:
      - run: |
          echo "Generating dynamic atlantis.yaml for $(basename $REPO_ROOT)"
          
          # Create dynamic atlantis.yaml
          cat > atlantis.yaml << EOF
          version: 3
          automerge: false
          parallel_plan: true
          parallel_apply: true
          projects:
          EOF

                    # Function to check if directory is a valid Terraform project
                    is_terraform_project() {
                      local dir="$1"
                      # Check for at least one of the main Terraform files
                      [ -f "$dir/main.tf" ] || [ -f "$dir/backend.tf" ] || [ -f "$dir/providers.tf" ]
                    }

                    # Function to discover environments from config directory
                    discover_environments() {
                      local dir="$1"
                      local config_dir="$dir/config"
                      
                      if [ -d "$config_dir" ]; then
                        # Find all .tfvars files and extract environment names
                        find "$config_dir" -name "*.tfvars" -type f | \
                        sed -E 's|.*/([^/]+)\.tfvars|\1|' | \
                        sort -u
                      else
                        # If no config directory, return empty
                        echo ""
                      fi
                    }

                    # Find all directories and check if they're valid Terraform projects
                    find . -type d -not -path "*/\.*" | while read dir; do
                      if is_terraform_project "$dir"; then
                        dir="${dir#./}"  # Remove leading ./
                        
                        # Discover available environments for this project
                        environments=$(discover_environments "$dir")
                        
                        if [[ -n "$environments" ]]; then
                          # Create a project for each environment
                          for env in $environments; do
                            if [[ "$dir" =~ ^application/([^/]+)$ ]]; then
                              app_name="${BASH_REMATCH[1]}"
                              project_name="${app_name}-${env}"
                            else
                              folder_name=$(basename "$dir")
                              project_name="${folder_name}-${env}"
                            fi
                            
                            cat >> atlantis.yaml << EOF
            - name: $project_name
              dir: $dir
              autoplan:
                enabled: true
                when_modified: ["$dir/**/*", "$dir/config/$env.tfvars", "$dir/env/$env/*"]
              terraform_version: v1.5.0
              apply_requirements: [approved, mergeable]
          EOF
                          done
                        else
                          # If no environments found, create a default project
                          if [[ "$dir" =~ ^application/([^/]+)$ ]]; then
                            project_name="app-${BASH_REMATCH[1]}"
                          else
                            project_name=$(echo "$dir" | sed 's|/|-|g')
                          fi
                          
                          cat >> atlantis.yaml << EOF
            - name: $project_name
              dir: $dir
              autoplan:
                enabled: true
                when_modified: ["$dir/**/*"]
              terraform_version: v1.5.0
              apply_requirements: [approved, mergeable]
          EOF
                        fi
                      fi
                    done

                    cat >> atlantis.yaml << EOF
workflows:
  multi_env_workflow:
    plan:
      steps:
        - run: |
            # Extract environment from project name
            if [[ "\$PROJECT_NAME" =~ -(production|staging|helia)$ ]]; then
              ENV="\${BASH_REMATCH[1]}"
              
              # Set backend config and var file paths based on environment
              case "\$ENV" in
                "production")
                  BACKEND_CONFIG="env/production/prod.conf"
                  VAR_FILE="config/production.tfvars"
                  ;;
                "staging")
                  BACKEND_CONFIG="env/staging/stage.conf"
                  VAR_FILE="config/stage.tfvars"
                  ;;
                "helia")
                  BACKEND_CONFIG="env/helia/helia.conf"
                  VAR_FILE="config/helia.tfvars"
                  ;;
                *)
                  BACKEND_CONFIG="env/staging/stage.conf"
                  VAR_FILE="config/stage.tfvars"
                  ;;
              esac
            else
              # Default to staging if no environment detected
              ENV="staging"
              BACKEND_CONFIG="env/staging/stage.conf"
              VAR_FILE="config/stage.tfvars"
            fi
            
            echo "Planning for environment: \$ENV"
            echo "Using backend config: \$BACKEND_CONFIG"
            echo "Using var file: \$VAR_FILE"
            
            # Initialize with backend config
            if [ -f "\$BACKEND_CONFIG" ]; then
              echo "Initializing with backend config: \$BACKEND_CONFIG"
              terraform init -backend-config="\$BACKEND_CONFIG" -input=false -reconfigure
            else
              echo "Warning: Backend config \$BACKEND_CONFIG not found, using default init"
              terraform init -input=false -reconfigure
            fi
            
            # Plan with var file
            if [ -f "\$VAR_FILE" ]; then
              terraform plan -var-file="\$VAR_FILE" -out="\$PLANFILE"
            else
              echo "Warning: Var file \$VAR_FILE not found, using default plan"
              terraform plan -out="\$PLANFILE"
            fi
    apply:
      steps:
        - run: |
            # Extract environment from project name (same logic as plan)
            if [[ "\$PROJECT_NAME" =~ -(production|staging|helia)$ ]]; then
              ENV="\${BASH_REMATCH[1]}"
              
              case "\$ENV" in
                "production")
                  BACKEND_CONFIG="env/production/prod.conf"
                  VAR_FILE="config/production.tfvars"
                  ;;
                "staging")
                  BACKEND_CONFIG="env/staging/stage.conf"
                  VAR_FILE="config/stage.tfvars"
                  ;;
                "helia")
                  BACKEND_CONFIG="env/helia/helia.conf"
                  VAR_FILE="config/helia.tfvars"
                  ;;
                *)
                  BACKEND_CONFIG="env/staging/stage.conf"
                  VAR_FILE="config/stage.tfvars"
                  ;;
              esac
            else
              ENV="staging"
              BACKEND_CONFIG="env/staging/stage.conf"
              VAR_FILE="config/stage.tfvars"
            fi
            
            echo "Applying for environment: \$ENV"
            echo "Using backend config: \$BACKEND_CONFIG"
            echo "Using var file: \$VAR_FILE"
            
            # Re-init with backend config for apply (to ensure consistency)
            if [ -f "\$BACKEND_CONFIG" ]; then
              terraform init -backend-config="\$BACKEND_CONFIG" -input=false -reconfigure
            fi
            
            # Apply with var file
            if [ -f "\$VAR_FILE" ]; then
              terraform apply -var-file="\$VAR_FILE" "\$PLANFILE"
            else
              terraform apply "\$PLANFILE"
            fi
            EOF
          
      